---
theme: smartblue
---

[é¡¹ç›®æºç ](https://github.com/moderateReact/moderate-react-template)
# åšè¿™ä¸ªå·¥å…·çš„åŠ¨æœº
å¶ç„¶é—´æˆ‘å¾€`webpack`æ ‡ç­¾ä¸­å‘äº†ä¸€ç¯‡æ–‡ç« ï¼Œç¢°å·§çœ‹åˆ°äº†ç„¶å”å†™çš„[åšäº†ä¸€å¤œåŠ¨ç”»ï¼Œè®©å¤§å®¶ååˆ†é’Ÿææ‡‚Webpack](https://juejin.cn/post/6961961165656326152)ï¼Œæˆ‘å¹¶ä¸äº†è§£ç„¶å”ï¼Œä½†æˆ‘è§‰å¾—ä»–å¾ˆå¯èƒ½æ¯”æˆ‘å¤§ï¼Œè€ƒè™‘åˆ°ä¸€ä½å¦‚æ­¤åŠªåŠ›åˆ†äº«æŠ€æœ¯çš„å¤§å“¥ï¼Œä¸ºäº†å¥‰çŒ®è‡ªå·±çš„å…‰å’Œçƒ­ï¼Œåšäº†ä¸€å¤œï¼Œé‚£å±å®è®©äººæœ‰äº›å¿ƒç–¼ï¼Œæ•…æˆ‘æƒ³å°½æˆ‘çš„ä¸€ç‚¹åŠ›ï¼Œä¸ºå¤§ä½¬å’Œå¤§å®¶ä»¬ä¹Ÿå‘å‡ºæˆ‘çš„ä¸€ä»½çƒ­ã€‚

# æˆ‘è¢«å¸å¼•äº†
é¦–å…ˆé¢†ç•¥äº†ä¸€ä¸‹æ–‡ç« ï¼Œå¹¶å°è¯äº†â€œä¸ç”¨æƒ³è‚¯å®šæ¯”æˆ‘å‚æ‚Ÿæ·±ï¼Œå¤§ä½¬å°±æ˜¯å¤§ä½¬â€è¿™ä¸ªâ€åè§â€œï¼Œä½†æœ€ç›´æ¥å¸å¼•æˆ‘å¹¶ä¸æ˜¯`webpack`ğŸ˜‚ï¼Œè€Œæ˜¯ä¸€æŸâ€œå…‰â€ï¼Œå¯¹å°±æ˜¯å¤§ä½¬å†™äº†ä¸€å¤œçš„åŠ¨ç”»ï¼Œæˆ‘æ„Ÿå¹åŠ¨ç”»åˆ¶ä½œçš„å¦‚æ­¤ä¹‹ç²¾å·§ï¼Œè¡¨è¾¾æ•ˆæœç«Ÿç„¶å¦‚æ­¤ä¹‹æ˜¾è‘—ï¼Œç›´æ¥åœ°ï¼Œå¼ºçƒˆåœ°å¸å¼•äº†æˆ‘ã€‚

# è¡ŒåŠ¨èµ·æ¥
ä¸å…¶æ²‰æµ¸åœ¨å–œçˆ±å’Œè†œæ‹œçš„æ„Ÿè§‰ä¸­ï¼Œä¸å¦‚å€Ÿç€è¿™ä»½æƒ…æ„Ÿåšç‚¹äº‹ã€‚æˆ‘å¿ƒä¸­å®¡è§†äº†ä¸€ä¸‹è‡ªå·±ç°æœ‰çš„èƒ½åŠ›ï¼Œå¾ˆå¿«å°±å¾—å‡ºäº†ä¸€ä¸ªæƒ³æ³•ğŸ’¡ï¼Œæˆ‘å¥½åƒèƒ½æ•´å‡ºæ¥ä¸€ä¸ªåšå‡ºè¿™ç§â€œå…‰â€çš„è½®å­ï¼Œokï¼Œè¯´å¹²å°±å¹²ã€‚

# æç»˜å‡ºè‡ªå·±çš„æœŸæœ›å°±æˆåŠŸäº†ä¸€åŠ
é¦–å…ˆæˆ‘ä¸æƒ³åšæˆé™æ€èµ„æºé‚£ç§çš„ï¼Œæ¯”å¦‚è§†é¢‘ï¼Œgifä¹‹ç±»çš„ï¼Œè¿™ç§æ˜¯æ²¡æœ‰â€œç”Ÿå‘½â€çš„ï¼Œåªèƒ½ç§°ä¹‹ä¸ºâ€œç‰©è´¨â€ï¼Œæˆ‘ç®€å•ç”¨â€œé˜´â€ä»£æŒ‡ï¼Œæˆ‘æ‰€éœ€è¦æ˜¯åŸºäºç‰©è´¨æ‰€ç„•å‘åŒæ—¶ä¹Ÿå¯ä»¥åˆ›é€ ç‰©è´¨çš„çš„â€œç”Ÿå‘½ï¼Œå¿ƒçµâ€ï¼Œæˆ‘ç§°ä»–ä¸ºé˜³ã€‚è¯´taæ˜¯â€œæ´»â€çš„æœ‰ç‚¹è¿‡ï¼Œå°±æ˜¯è¯´å¯ä»¥äº¤äº’ï¼Œå¯ä»¥æ•´åˆå†åˆ©ç”¨ï¼Œéšæ—¶å¯ä»¥é€šè¿‡taåˆ›å»ºè§†é¢‘ï¼Œgifä¹‹ç±»çš„é™æ€èµ„æºï¼Œå²‚ä¸å¦™å“‰ã€‚

# åŸºäºæœŸæœ›æˆ‘ç¡®å®šäº†å®ç°æ–¹æ¡ˆ
é¦–å…ˆä½œä¸ºä¸€ä¸ªå‰ç«¯ï¼ŒæŠ€æœ¯é¢è¦æ‰“å¼€ï¼Œå°±å¾ˆå®¹æ˜“æ¥è§¦åˆ°å½¢å½¢è‰²è‰²çš„æŠ€æœ¯ï¼Œé‚£ä¹ˆæ¸²æŸ“å¼•æ“å°±æ˜¯ä¹‹ä¸€ã€‚é¦–å…ˆå‡ºäºæˆ‘çš„éœ€æ±‚ï¼Œé€šè¿‡æ¸²æŸ“å¼•æ“å¼€å‘è¿™ä¼šå¤§å¤§çš„æé«˜å¼€å‘çš„æ•ˆç‡ï¼Œå…¶æ¬¡ä¹Ÿå¯ä»¥æ•´åˆè¿›æˆ‘å†™çš„è„šæ‰‹æ¶[â€œModerateâ€](https://juejin.cn/column/6975459265653768205)ä¸­ï¼Œæ˜¯ä¸€ä¸ªä¼˜è§£ã€‚

# è®¾è®¡å¼€å‘
æˆ‘æ€»å¸Œæœ›ç”¨æœ€ç®€å•çš„è¯è¯­ï¼Œæè¿°ä¸€ä»¶äº‹ï¼Œæˆ‘æ¯”è¾ƒå–œæ¬¢ç®€å•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç”¨ç®€å•çš„æ–¹å¼æŠŠæˆ‘çš„è®¾è®¡è®²è®²ã€‚

## é€šè¿‡é¼ æ ‡æˆ–è§¦æ‘¸æ»‘åŠ¨ï¼Œæ¨è¿›åŠ¨ç”»è¿›ç¨‹
è§†é¢‘å¯ä»¥å¿«è¿›ï¼Œå€’é€€ï¼Œä»…ä»…é€šè¿‡æ‹¨åŠ¨è¿›åº¦æ¡æˆ–è€…æ»‘åŠ¨å±å¹•å³å¯ï¼Œæˆ‘å–œæ¬¢è¿™ç§äº¤äº’ï¼Œé‚£å°±åšæˆè¿™æ ·ï¼Œèˆ’æœã€‚

## è®¾è®¡å¥½ä¸ªä½“ï¼Œéå¸¸å…³é”®
æˆ‘å¸Œæœ›è®¾è®¡å‡ºä¸€ç³»åˆ—ç‹¬ç«‹ä¸ªä½“ï¼Œå¯ä»¥å¾ˆå¥½çš„ä¸²è”èµ·æ•´ä¸ªé€»è¾‘ï¼Œå®ƒå…·å¤‡äº†åŸºæœ¬çš„åŠŸèƒ½ï¼ŒåŒæ—¶åˆå…·å¤‡äº†æ‰©å±•çš„èƒ½åŠ›ï¼Œå¯äº’ç›¸è”ç»“ï¼Œåˆå½¼æ­¤ç‹¬ç«‹ï¼Œç›®å‰æœ‰ä¸¤ä¸ªä¸»è¦çš„ä¸ªä½“ï¼Œä¸€ä¸ªæ˜¯å•ä½ä¸ªä½“`entity`ï¼Œå¦ä¸€ä¸ªæ˜¯åŠ¨ä½œä¸ªä½“`recation`


### `entity`å¤§ä½“åº”è¯¥å…·å¤‡ä»¥ä¸‹è¡Œä¸ºï¼š
* æè¿°è‡ªèº«è¿è¡Œçš„å‘¨æœŸï¼š `lenPercent`å’Œ`startPercent`
* ç”Ÿå‘½å‘¨æœŸå‡½æ•°
    * å¼€å§‹ï¼š`live`
    * æ¸²æŸ“ï¼š`process`
    * ç»“æŸï¼š`end`
* å¯ä»¥è£…è½½å…¶ä»–ä¸ªä½“çš„èƒ½åŠ›ï¼š`entityArr`
    * ç»„æˆå•ä½ä¸ºï¼š`entity`
* æ‰§è¡ŒåŠ¨ä½œçš„é›†åˆï¼š`recationArr`
    * ç»„æˆå•ä½ä¸ºï¼š`recation`,

### `recation`å¤§ä½“åº”è¯¥å…·å¤‡ä»¥ä¸‹è¡Œä¸ºï¼š
* æè¿°è‡ªèº«è¿è¡Œçš„å‘¨æœŸï¼š`start`å’Œ`end`
* æ‰§è¡Œçš„åŠ¨ä½œï¼š`action()`

é‚£ä¹ˆä¸ªä½“è®¾è®¡å¥½äº†ï¼Œå›´ç»•ä¸ªä½“æ‰€å±•å¼€çš„é€»è¾‘ï¼Œå°±é¡ºç†æˆç« äº†ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```js
export default cc.Class({
    extends: cc.Component,

    properties: {

        lenPercent: cc.Float,
        startPercent: cc.Float,
        isAutoStart: cc.Boolean,
        entityArr: {
            default: [],
            type: cc.Node
        }
    },

    //externalDurationï¼šå¤–éƒ¨æ—¶é—´ï¼ˆçˆ¶èŠ‚ç‚¹ä¼ è¿‡æ¥çš„æ—¶é—´ï¼‰ï¼Œç”±çˆ¶èŠ‚ç‚¹å†³å®š
    //internalDurationï¼šè‡ªå·±å†…éƒ¨å®šçš„æ—¶é—´ï¼Œæœ‰è‡ªå·±å†³å®šï¼Œ
    //ä¸ºä»€ä¹ˆè¦åŒºåˆ†ä¸¤ä¸ªå‘¢ï¼Ÿç”±äºå¤–éƒ¨åº”è¯¥åªèƒ½ç¡®å®šæˆ‘çš„æ’­æ”¾æ—¶é—´ï¼Œä¸åº”è¯¥å†³å®šæˆ‘çš„æ’­æ”¾é€Ÿç‡ï¼Œè€Œåè€…åº”è¯¥æœ‰ä¸ªä½“è‡ªèº«å†³å®šï¼Œ
    //startTimeå’ŒendTime:ç”±çˆ¶èŠ‚ç‚¹æŒ‡å®šçš„å¼€å§‹å’Œç»“æŸæ—¶é—´ï¼Œ(æ ¹æ®çˆ¶èŠ‚ç‚¹çš„ä¸–ç•Œå®šçš„â€˜å¤–éƒ¨æ—¶é—´â€™!!!)
    //timeLine-è¡¨ç¤ºæ—¶é—´åˆ°å“ªäº†ï¼Œ(æ ¹æ®çˆ¶èŠ‚ç‚¹çš„ä¸–ç•Œå®šçš„â€˜å¤–éƒ¨æ—¶é—´â€™!!!)
    //totaTime-è¡¨ç¤ºæˆ‘åœ¨çˆ¶èŠ‚ç‚¹åº”è¯¥æ’­æ”¾çš„æ€»æ—¶é•¿ï¼Œ(æ ¹æ®çˆ¶èŠ‚ç‚¹çš„ä¸–ç•Œå®šçš„â€˜å¤–éƒ¨æ—¶é—´â€™!!!)
    //progressValueå°±æ˜¯é€šè¿‡çˆ¶èŠ‚ç‚¹ä¼ è¿‡æ¥çš„timeLineï¼ŒtotaTimeï¼ŒtimeLineå¾—å‡ºæˆ‘å¤„äºçš„æ’­æ”¾è¿›åº¦ç™¾åˆ†æ¯”
    //ç›¸åº”çš„å¾€è‡ªå·±çš„å­èŠ‚ç‚¹ä¼ çš„å°±å¾—å‚ç…§è‡ªå·±çš„
    ctor() {
        this.isLive = false;
        this.startTime = undefined;
        this.endTime = undefined;
        this.internalDuration = 0;//ä¸ªä½“å†…éƒ¨çš„æ—¶é•¿
        this.externalDuration = 0;//ä¸ªä½“ç›¸å¯¹çˆ¶çº§çš„æ—¶é•¿
        this.progressValue = 0;
        this.entryData = [];
        this.recationArr = [];
        this.startPosition = cc.v2();
        this.entityArrEx = [];
    },

    // LIFE-CYCLE CALLBACKS:
    start() {
        this.startPosition = this.node.position;
    },
    onLoad() {
        this.node.comName = this.__classname__;
        this.internalDuration = this.node.getContentSize().height;
        //é˜²æ­¢è®¾ç½®çš„æ—¶é—´å¤ªé•¿ï¼Œå¼ºåˆ¶è®¾ç½®ä¸ºå‰©ä½™çš„æ—¶é•¿
        if (this.lenPercent + this.startPercent > 1) {
            this.lenPercent = 1 - this.startPercent;
        }
        if (this.isAutoStart) {
            this.startPercent += Math.abs((this.node.position.y / this.node.parent.getContentSize().height));
        }

    },

    onEnable() {
        let self = this;
        if (this.entityArr.length) {
            this.entityArrEx = this.entityArr.map((item, index) => {
                let entity = item.getComponent(item._name);
                if (entity.isAutoStart) {

                }
                this.entryData.push(entity.initData({
                    startTime: this.getStarTime(entity.startPercent),
                    totaTime: self.internalDuration,
                }));
                return entity;
            });
        }
    },

    //ä¸šåŠ¡æ¥å£
    getStarTime(value) {
        if (value <= 1) {
            return value * this.internalDuration
        } else {
            return value
        }
    },

    initData({ totaTime, startTime }) {
        this.startTime = startTime;
        this.externalDuration = this.lenPercent <= 1 ? totaTime * this.lenPercent : this.lenPercent;
        //ç»“æŸæ—¶é—´æœ€å¤§åªèƒ½æ˜¯çˆ¶ç±»èŠ‚ç‚¹ç»“æŸæ—¶é—´
        //å› ä¸ºçˆ¶èŠ‚ç‚¹ç»“æŸï¼Œå­èŠ‚ç‚¹ä¹Ÿå¿…é¡»ç»“æŸ
        this.endTime = Math.min(totaTime, this.startTime + this.externalDuration);
        return {
            startTime: this.startTime,
            internalDuration: this.internalDuration,
            endTime: this.endTime
        }
    },

    getCurrentTime(percent) {
        return (
            this.startTime + (percent <= 1 ? this.externalDuration * percent : percent)
        );
    },

    live() {
        this.isLive = true;
    },

    calcProgress() {
        this.progressValue = (this.timeLine - this.startTime) / this.externalDuration;
    },

    calcReactionProgress({ start, end }) {
        start = (start <= 1) ? this.internalDuration * start : start;
        end = (end <= 1) ? this.internalDuration * end : end;
        return Math.min((this.progressValue * this.internalDuration - start) / (end - start), 1);
    },

    process({ timeLine }) {
        this.timeLine = timeLine;
        this.calcProgress();
        this.internalTimeLine = this.progressValue * this.internalDuration;
        let actionArr = this.recationArr.filter((item) => {
            if (item) {
                let isOk = (timeLine > this.getCurrentTime(item.start) &&
                    timeLine <= this.getCurrentTime(item.end)) ||
                    (!item.start && !item.end)
                if (isOk) {
                    item.isAction = true
                } else {
                    if (item.isAction) {
                        item.action(this.calcActionData(item, true))
                    }
                    item.isAction = false
                }
                return isOk;
            }
        });
        actionArr.forEach((item) => {
            item.action(this.calcActionData(item));
        });
    },

    update() {
        let self = this;
        this.actionEntityArr = this.entityArrEx.filter((entity) => {
            if ((self.internalTimeLine) > entity.startTime && self.internalTimeLine <= entity.endTime) {
                if (!entity.isLive) {
                    entity.live();
                }
                entity.process({
                    timeLine: self.progressValue * self.internalDuration,
                });
                return true;
            } else {
                if (entity.isLive) {
                    entity.end();
                }
            }
            return false;
        });
    },

    calcActionData(item, isEnd) {
        let params = {};
        let actionLen = (item.end - item.start) || 1;
        let progress;
        progress = Math.min((this.progressValue - item.start) / actionLen, 1);
        if (isEnd) {
            let isEndForce = window.GLOBAL.dir > 0;
            let isEndForceStart = window.GLOBAL.dir < 0;
            if (isEndForce) {
                progress = 1
            } else if (isEndForceStart) {
                progress = 0
            }
            params = {
                isEndForce: isEndForce,
                isEndForceStart: isEndForceStart
            }
        }
        params = {
            actionLen,
            progress,
            ...params,
            ...item
        }

        return params;
    },
    end() {
        this.isLive = false;
        //å¦‚æœæ»‘åŠ¨éå¸¸å¿«ï¼Œå¹¶ä¸”æ˜¯å¿«è¿›è€Œéåé€€ï¼Œé‚£ä¹ˆå°±è¦ç›´æ¥å¼ºè¡Œè®¾ç½®åé¦ˆä¸ºç»“æŸ
        // if (window.GLOBAL.dir > 0) {

        // }
        this.recationArr.forEach(item => {
            if (item.isAction) {
                item.isAction = false
                item.action(this.calcActionData(item, true))
            }
        });
    },
});

```


# çœ‹ä¸‹æ•ˆæœï¼š
è¿™æ˜¯ç„¶å“¥çš„åšçš„åŠ¨ç”»
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f871e2c172ec406895c21a2881fdb0ef~tplv-k3u1fbpfcp-zoom-1.image)

![](https://s1.imagehub.cc/images/2021/06/29/9df1b81ac3d5409898026bba21cebab3tplv-k3u1fbpfcp-watermark.image901ce18b294ad643.gif)

æˆ‘çš„ç‰ˆæœ¬ï¼ˆåšçš„æ—¶å€™æ‰å‘ç°è¿™ä¿©æ˜¯ä¸€ä½“çš„ï¼‰
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e76203df95e4af18fc7c9f872d4cc3d~tplv-k3u1fbpfcp-zoom-1.image)

# æˆ‘çš„æ„å¤–æ”¶è·

å°±åœ¨æˆ‘å¼€å§‹ç€æ‰‹åš[ç„¶å”](https://juejin.cn/post/6961961165656326152)ç¬¬ä¸‰ä¸ªåŠ¨ç”»ï¼Œæ‘¸ç´¢ç®­å¤´å¦‚ä½•å®ç°çš„æ—¶å€™ï¼Œæœºç¼˜å·§åˆåœ°æˆ‘æœ‰äº†å¦ä¸€ä¸ªæ–°çš„çµæ„Ÿï¼Œæˆ‘åšå‡ºäº†è¿™ä¸ªã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2002257d6d3a4db58c7fa7bedfa0cfdd~tplv-k3u1fbpfcp-zoom-1.image)

[â€œModerateâ€](https://juejin.cn/column/6975459265653768205)æ–°é¦–é¡µã€‚

æ„Ÿè°¢ç„¶å”ã€‚

# ç»“è¯­
è¿™æ˜¯æˆ‘ä¸º[â€œModerateâ€](https://juejin.cn/column/6975459265653768205)å†™ä¸“æ çš„ç¬¬åç¯‡äº†ï¼Œå¾ˆæœ‰æˆå°±æ„Ÿï¼Œè™½ç„¶ä¸å—æ¬¢è¿ï¼Œä½†æ•´ä¸ªè¿‡ç¨‹æˆ‘æ˜¯å¿«ä¹çš„ã€‚æˆ‘é‡è§äº†å¥½å¤šå¥½å¤šçƒ­æƒ…çš„ï¼Œæ‰åçš„ï¼Œå¯æ•¬çš„coderå’Œæ˜å‹ï¼Œæ”¶è·è‰¯å¤šã€‚æœ€åç”±è¡·åœ°æ„Ÿè°¢æ˜é‡‘è¥é€ çš„ç¤¾åŒºæ°›å›´ï¼Œæ„Ÿå¹ç›¸è§æ¨æ™šï¼Œä½†ä¸€è§å¦‚æ•…ï¼Œè‡ªå¼ºä¸æ¯ï¼Œæœªæ¥å¯æœŸã€‚
