# å¼ºåŒ–ä¸€æ³¢hooksåŸç†

é¦–å…ˆ`hooks`å·²ç»æ¨å‡ºå¾ˆä¹…ï¼Œæƒ³å¿…å¤§å®¶æˆ–å¤šæˆ–å°‘éƒ½ä½¿ç”¨è¿‡æˆ–è€…äº†è§£è¿‡`hooks`ï¼Œä¸çŸ¥æ˜¯å¦ä¼šå’Œæˆ‘ä¸€æ ·éƒ½æœ‰ä¸€ç§æ„Ÿå—ï¼Œé‚£å°±æ˜¯`hooks`ä½¿ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œä½†æ€»æ„Ÿè§‰åƒæ˜¯ä¸€ç§é­”æ³•ï¼Œå¹¶ä¸æ˜¯å¾ˆæ¸…æ¥šå…¶å†…éƒ¨å¦‚ä½•å®ç°çš„ï¼Œå¾ˆéš¾å¾—å¿ƒåº”æ‰‹ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—è¦æƒ³çœŸæ­£é©¾é©­`hooks`ï¼Œåº”è¯¥å…ˆä»äº†è§£å…¶å†…éƒ¨åŸç†å¼€å§‹ï¼Œå†è®²ä½¿ç”¨ã€‚

# hooksæ‰­è½¬äº†å‡½æ•°ç»„ä»¶çš„æ©˜åŠ¿
## hooks ä¹‹å‰
### å‡½æ•°ç»„ä»¶çš„åŸºå› é™åˆ¶

å‡½æ•°ç»„ä»¶å¯ä»¥ç²—ç•¥çš„è®¤ä¸ºå°±æ˜¯ç±»ç»„ä»¶çš„`render`å‡½æ•°ï¼Œå³ä¸€ä¸ªè¿”å›`jsx`ä»è€Œåˆ›å»ºè™šæ‹Ÿ`dom`çš„å‡½æ•°ã€‚

ç±»ç»„ä»¶æœ‰`this`ï¼Œèƒ½å¤Ÿæ‹¥æœ‰è‡ªå·±çš„å®ä¾‹æ–¹æ³•ï¼Œå˜é‡ï¼Œè¿™æ ·å¾ˆå®¹æ˜“å°±å¯ä»¥å®ç°å„ç§ç‰¹æ€§ï¼Œæ¯”å¦‚`state`å’Œç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œæ¯ä¸€æ¬¡æ¸²æŸ“éƒ½å¯ä»¥è®¤ä¸ºæ˜¯â€œæ›¾ç»"çš„è‡ªå·±åœ¨ä¸æ–­è„±å˜ï¼Œæœ‰å»¶ç»­æ€§ã€‚

åè§‚å‡½æ•°ç»„ä»¶å°±æ— æ³•å»¶ç»­ï¼Œæ¯ä¸€æ¬¡æ¸²æŸ“éƒ½æ˜¯â€œæ–°â€çš„è‡ªå·±ï¼Œè¿™å°±æ˜¯å‡½æ•°ç»„ä»¶çš„â€œåŸºå› é™åˆ¶â€ï¼Œæœ‰ç‚¹åƒç« é±¼ã€‚

### å‡½æ•°ç»„ä»¶å’Œç±»ç»„ä»¶ä¸€ä¸ªâ€œå°å·®å¼‚â€

é¦–å…ˆä¸€ä¸ªç»„ä»¶å¯ä»¥åˆ†åˆ«ç”¨ç±»ç»„ä»¶å’Œå‡½æ•°ç»„ä»¶å†™å‡ºä¸¤ä¸ªç‰ˆæœ¬ï¼Œå¯¹å§

**ç±»ç»„ä»¶ï¼š**
```js
class CompClass extends Component {

 showMessage = () => {
 	console.log("ç‚¹å‡»çš„è¿™ä¸€åˆ»ï¼Œpropsä¸­infoä¸º " + this.props.info);
 };

 handleClick = () => {
	 setTimeout(this.showMessage, 3000);
	 console.log(`å½“å‰propsä¸­çš„infoä¸º${this.props.info},ä¸€è‡´å°±è¯´æ˜å‡†ç¡®çš„å…³è”åˆ°äº†æ­¤æ—¶çš„renderç»“æœ`)
 };

 render() {
 	return <div onClick={this.handleClick}>
		 <div>ç‚¹å‡»ç±»ç»„ä»¶</div>
	</div>;
 }
}
```

**å‡½æ•°ç»„ä»¶ï¼š**
```js
function CompFunction(props) {
	
	const showMessage = () => {
		console.log("ç‚¹å‡»çš„è¿™ä¸€åˆ»ï¼Œpropsä¸­infoä¸º " + props.info);
	};
 
	const handleClick = () => {
		setTimeout(showMessage, 3000);
		console.log(`å½“å‰propsä¸­çš„infoä¸º${props.info},ä¸€è‡´å°±è¯´æ˜å‡†ç¡®çš„å…³è”åˆ°äº†æ­¤æ—¶çš„		renderç»“æœ`)
	};

return <div onClick={handleClick}>ç‚¹å‡»å‡½æ•°ç»„ä»¶</div>;
}
```

é‚£ä¹Ÿå°±è¯´è¿™ä¸¤è€…ä¸åŒå†™æ³•æ˜¯ç­‰ä»·çš„ï¼Œå¯¹ä¹ˆï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼š**é€šå¸¸æƒ…å†µä¸‹æ˜¯ç­‰ä»·çš„ï¼Œä½†æ˜¯æœ‰ç§æƒ…å†µäºŒè€…ä¸åŒ**ï¼Œæ¯”å¦‚

```js
export default function App() {
 const [info, setInfo] = useState(0);
 return (
	 <div>
		 <div onClick={()=>{
		 	setInfo(info+1)
		 }}>çˆ¶ç»„ä»¶çš„infoä¿¡æ¯>> {info}</div>
		 <CompFunction info = {info}></CompFunction>
		 <CompClass info = {info}></CompClass>
	 </div>
 );
}
```


é€šè¿‡ä»£ç èƒ½å¤Ÿçœ‹å‡ºï¼š
1. åœ¨ç»„ä»¶`App`ä¸­ï¼Œæœ‰ä¸ªçŠ¶æ€`info`å…¶åˆå§‹å€¼ä¸º0ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ç‚¹å‡»ä¿®æ”¹
2. `CompFunction`å’Œ`CompClass`æ˜¯ä½œä¸ºå­ç»„ä»¶æ˜¾ç¤ºï¼Œå¹¶ä¸”éƒ½æ¥å—çˆ¶ç»„ä»¶çš„`info`ä½œä¸ºå‚æ•°ï¼Œ
3. è¿™ä¸¤ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ªç‚¹å‡»å›è°ƒï¼Œç‚¹å‡»ä¹‹åéƒ½ä¼šè§¦å‘ä¸€ä¸ªå»¶è¿Ÿ3ç§’çš„`setTimeout`ï¼Œç„¶åæŠŠä»çˆ¶ç»„ä»¶`App`ä¸­è·å¾—`info`ï¼Œ`log`å‡ºæ¥

é‚£å°±æµ‹è¯•ä¸€ä¸‹ï¼š
1. å°±æ˜¯å¿«é€Ÿç‚¹å‡»`CompFunction`å’Œ`CompClass`ï¼Œä»¥è§¦å‘å…¶å†…éƒ¨çš„`setTimeout`ï¼Œç­‰å¾…3ç§’ä¹‹åï¼Œçœ‹çœ‹æ‰“å°ä»çˆ¶ç»„ä»¶`App`ä¸­è·å¾—`info`ä¿¡æ¯
2. ç„¶åå†ç‚¹å‡»çˆ¶ç»„ä»¶è¿›è€Œä¿®æ”¹`info`,åªè¦å˜äº†å°±è¡Œï¼Œå‡è®¾å˜æˆäº†5ã€‚
(*å»ºè®®åŠ¨æ‰‹è¯•ä¸€ä¸‹ã€‚*)

ç»“æœï¼š
1. å‡½æ•°ç»„ä»¶`CompFunction`ä¼šè¾“å‡ºï¼š0
2. ç±»ç»„ä»¶`CompClass`ä¼šè¾“å‡ºï¼š5

**ç»“æœä¸åŒï¼ŒæŒ‰é“ç†è®²åº”è¯¥ç­‰ä»·å•Šï¼Œä¸ºä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ**

**è§£é‡Šï¼š**

å‡½æ•°ç»„ä»¶æ‰§è¡Œï¼Œå°±ä¼šå½¢æˆä¸€ä¸ªé—­åŒ…ï¼Œå¯ä»¥å½¢è±¡åœ°è¯´æˆ**renderç»“æœ**ï¼Œå…¶ä¸­åŒ…æ‹¬`props`ï¼Œè€Œç‚¹å‡»äº‹ä»¶çš„å¤„ç†å‡½æ•°åŒæ ·ä¹ŸåŒ…æ‹¬åœ¨å†…ï¼Œé‚£å®ƒæ— è®ºæ˜¯ç«‹å³æ‰§è¡Œè¿˜æ˜¯å»¶è¿Ÿæ‰§è¡Œï¼Œéƒ½åº”è¯¥ä¸è§¦å‘æ‰§è¡Œçš„é‚£ä¸€åˆ»çš„**renderç»“æœ**ï¼ˆä½ ä¹Ÿå¯ä»¥ç†è§£ä¸ºé‚£ä¸€åˆ»çš„å¿«ç…§ï¼‰ç›¸å…³è”ã€‚
æ‰€ä»¥å›è°ƒå‡½æ•°`showMessage`æ‰€åº”è¯¥`log`å‡ºçš„`info`ï¼Œåº”è¯¥ä¸ºäº‹ä»¶è§¦å‘çš„é‚£ä¸€åˆ»`render`ç»“æœä¸­çš„`info`ï¼Œä¹Ÿå°±æ˜¯"1"ï¼Œæ— è®ºå¤–éƒ¨çš„infoæ€ä¹ˆå˜ã€‚

è€Œç±»ç»„ä»¶å°±ä¼šè¾“å‡º`info`çš„æœ€æ–°å€¼ï¼Œä¹Ÿå°±æ˜¯"5"ã€‚

**ç»“è®ºï¼š**

è¿™ä¸ªâ€œå°å·®å¼‚â€å°±å«åš**capture value**

> [æ¯æ¬¡ Render çš„å†…å®¹éƒ½ä¼šå½¢æˆä¸€ä¸ªå¿«ç…§å¹¶ä¿ç•™ä¸‹æ¥ï¼Œå› æ­¤å½“çŠ¶æ€å˜æ›´è€Œ Rerender æ—¶ï¼Œå°±å½¢æˆäº† N ä¸ª Render çŠ¶æ€ï¼Œè€Œæ¯ä¸ª Render çŠ¶æ€éƒ½æ‹¥æœ‰è‡ªå·±å›ºå®šä¸å˜çš„ Props ä¸ Stateã€‚](https://segmentfault.com/a/1190000018685253?utm_source=tag-newest#:~:text=%E6%AF%8F%E6%AC%A1%20Render%20%E7%9A%84%E5%86%85%E5%AE%B9%E9%83%BD%E4%BC%9A%E5%BD%A2%E6%88%90%E4%B8%80%E4%B8%AA%E5%BF%AB%E7%85%A7%E5%B9%B6%E4%BF%9D%E7%95%99%E4%B8%8B%E6%9D%A5%EF%BC%8C%E5%9B%A0%E6%AD%A4%E5%BD%93%E7%8A%B6%E6%80%81%E5%8F%98%E6%9B%B4%E8%80%8C%20Rerender%20%E6%97%B6%EF%BC%8C%E5%B0%B1%E5%BD%A2%E6%88%90%E4%BA%86%20N%20%E4%B8%AA%20Render%20%E7%8A%B6%E6%80%81%EF%BC%8C%E8%80%8C%E6%AF%8F%E4%B8%AA%20Render%20%E7%8A%B6%E6%80%81%E9%83%BD%E6%8B%A5%E6%9C%89%E8%87%AA%E5%B7%B1%E5%9B%BA%E5%AE%9A%E4%B8%8D%E5%8F%98%E7%9A%84%20Props%20%E4%B8%8E%20State%E3%80%82)

`class`ç»„ä»¶æƒ³åšåˆ°è¿™ä¸€ç‚¹ï¼Œå¤šå°‘æœ‰ç‚¹éš¾ï¼Œæ¯•ç«Ÿthisè¿™ä¸ªå¥¶é…ªè¢«Reactç»™åŠ¨äº†ã€‚

**capture value**æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œä¸è¿‡æ²¡å…³ç³»æœ‰åŠæ³•è§£å†³ï¼ˆåé¢ä¼šè®²ï¼‰


## hooks ä¹‹å
### hooksè®©è¿™ä¸ªâ€œrenderâ€å‡½æ•°æˆç²¾äº†

å¦‚æœè¯´åœ¨`hooks`ä¹‹å‰ï¼Œå‡½æ•°ç»„ä»¶æœ‰ä¸€äº›â€œç¡¬ä¼¤â€ï¼Œå…¶ç‹¬ç‰¹ä¹‹å¤„ä¸è¶³ä»¥æ”¯æ’‘å®ƒä¸ç±»ç»„ä»¶åˆ†åº­æŠ—ç¤¼ï¼Œä½†æ˜¯å½“`hooks`çš„åˆ°æ¥ä¹‹åï¼Œæ©˜åŠ¿å°±ä¸ä¸€æ ·äº†ï¼Œè¿™ä¸ªæ›¾ç»çš„â€œ`render`â€å‡½æ•°ä¸€ä¸‹å°±èµ°èµ·æ¥äº†ã€‚

### hookså¸®å‡½æ•°ç»„ä»¶æ‰“ç¢äº†åŸºå› é”ã€‚

æˆ‘ä»¬ä¹‹å‰èŠäº†ï¼Œå‡½æ•°ç»„ä»¶æœ€å¤§çš„ç¡¬ä¼¤å°±æ˜¯"**æ¬¡æ¬¡é‡æ¥ï¼Œæ— æ³•å»¶ç»­**" ï¼Œå¾ˆéš¾è®©å®ƒå…·å¤‡è·Ÿç±»ç»„ä»¶é‚£æ ·çš„èƒ½åŠ›ï¼Œæ¯”å¦‚ç”¨çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼Œè€Œå¦‚ä»Š`hooks`çš„åŠ æŒï¼Œå¾ˆå¥½çš„ç²‰ç¢äº†è¢«ç±»ç»„ä»¶å…‹åˆ¶çš„æ·é”ã€‚

æ‰€ä»¥è¯´åœ¨äº†è§£å¦‚ä½•ä½¿ç”¨`hooks`ä¹‹å‰ï¼Œæœ€å¥½è¦å…ˆäº†è§£å‡½æ•°ç»„ä»¶æ˜¯æ€ä¹ˆæ‹¥æœ‰äº†å»¶ç»­æ€§ï¼Œè¿™æ ·ä½¿ç”¨`hooks`å°±â€æœ‰è°±â€œï¼Œå¦åˆ™ä½ å°±ä¼šè§‰å¾—`hooks`åˆ°å¤„éƒ½æ˜¯é»‘é­”æ³•ï¼Œè¿™ä¹ˆæ•´å°±ä¸æ˜¯å¾ˆâ€é è°±â€œäº†ã€‚


---

# æƒ³è¦äº†è§£Hookså»¶ç»­çš„å¥¥ç§˜ï¼Œä½ å¯èƒ½å¾—è®¤è¯†ä¸€ä¸‹Fiber

æ²¡æœ‰å»¶ç»­æ€§ï¼Œé‘è®ºå…¶ä»–ï¼ŒçœŸæ­£è®©å‡½æ•°ç»„ä»¶æœ‰å»¶ç»­æ€§çš„å¹•åçœŸå¤§ä½¬å®é™…ä¸Šæ˜¯`Fiber`ï¼Œä¸ºäº†èƒ½å¤Ÿå¾ˆå¥½çš„äº†è§£Reactæ€ä¹ˆå®ç°çš„è¿™ä¹ˆå¤šç§`hooks`ï¼Œé‚£ä¹ˆ`Fiber`ä½ æ˜¯ç»•ä¸å¼€çš„ï¼Œä¸è¿‡å­¦ä¹ `Fiber`ä¸ç”¨å¤ªç”¨åŠ›ï¼Œ**ç‚¹åˆ°ä¸ºæ­¢**ï¼Œæˆ‘ä¼šå°½å¯èƒ½çš„æµ…å‡ºï¼Œæˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯èƒ½å¤Ÿæ›´å¥½çš„ç†è§£å’Œä½¿ç”¨`Hooks`ï¼Œæ¯•ç«Ÿåƒé¥ºå­å˜›ï¼Œä¸ç”¨éå¾—é‚£ä¹ˆæ¸…æ¥šæ€ä¹ˆåšçš„ã€‚

## fiber çš„ç»“æ„
```js
type Fiber = {

 // å‡½æ•°ç»„ä»¶è®°å½•ä»¥é“¾è¡¨å½¢å¼å­˜æ”¾çš„hooksä¿¡æ¯ï¼Œç±»ç»„ä»¶å­˜æ”¾`state`ä¿¡æ¯
 memoizedState: any,

 // å°†diffå¾—å‡ºçš„ç»“æœæäº¤ç»™çš„é‚£ä¸ªèŠ‚ç‚¹

 return: Fiber | null,

 // å•é“¾è¡¨ç»“æ„ childï¼šå­èŠ‚ç‚¹ï¼Œsiblingï¼šå…„å¼ŸèŠ‚ç‚¹

 child: Fiber | null,

 sibling: Fiber | null,
 
 ...


 // æ¯ä¸ªworkinprogresséƒ½ç»´æŠ¤äº†ä¸€ä¸ªeffect listï¼ˆå¾ˆå¤æ‚ï¼Œä¸ä¼šä¹Ÿä¸è€½è¯¯æˆ‘ä»¬åƒé¥ºå­ï¼‰

 nextEffect: Fiber | null,

 firstEffect: Fiber | null,

 lastEffect: Fiber | null,

 ...

}
```
## Fiber çš„ç”±æ¥

Reactåˆ°åº•æ˜¯å¦‚ä½•å°†é¡¹ç›®æ¸²æŸ“å‡ºæ¥çš„ã€‚

é¦–å…ˆè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºâ€œreconcilerâ€ï¼Œå¯ä»¥å…ˆç²—ç•¥è®²reconcileråˆ’åˆ†å‡ºä¸¤ä¸ªé˜¶æ®µã€‚

1. **reconciliation** ï¼šé€šè¿‡diffè·å¾—å˜åŠ¨çš„ç»“æœã€‚
2. **commit**ï¼šå°†å˜åŠ¨ä½œç”¨åˆ°ç”»é¢ä¸Šï¼ˆ`side effect`å³å‰¯ä½œç”¨ï¼Œå¦‚`dom`æ“ä½œï¼‰ã€‚

`reconciliation`æ˜¯å¼‚æ­¥çš„ï¼Œ`commit`æ˜¯åŒæ­¥çš„ã€‚

### åœ¨fiberä¹‹å‰ï¼ŒReactæ˜¯å¦‚ä½•å®ç°çš„reconciliation

ä»å¤´åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿdomå³`vdom`ï¼Œä¸æ—§çš„`vdom`è¿›è¡Œæ¯”å¯¹ï¼Œä»è€Œå¾—å‡º`diff`ç»“æœï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€’å½’ï¼Œéœ€è¦ä¸€æ°”å‘µæˆï¼Œä¸èƒ½åœçš„ï¼Œè¿™æ ·JavaScripté•¿æ—¶é—´çš„å ç”¨ä¸»çº¿ç¨‹ï¼Œå°±ä¼šé˜»å¡ç”»é¢çš„æ¸²æŸ“ï¼Œå°±å¾ˆå¡ã€‚

>å› ä¸ºJavaScriptåœ¨æµè§ˆå™¨çš„ä¸»çº¿ç¨‹ä¸Šè¿è¡Œï¼Œæ°å¥½ä¸æ ·å¼è®¡ç®—ã€å¸ƒå±€ä»¥åŠè®¸å¤šæƒ…å†µä¸‹çš„ç»˜åˆ¶ä¸€èµ·è¿è¡Œã€‚å¦‚æœJavaScriptè¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œå°±ä¼šé˜»å¡è¿™äº›å…¶ä»–å·¥ä½œï¼Œå¯èƒ½å¯¼è‡´æ‰å¸§ã€‚

ï¼ˆå¼•è‡ª[Optimize JavaScript Execution](https://developers.google.com/web/fundamentals/performance/rendering/optimize-javascript-execution#reduce_complexity_or_use_web_workers)ï¼‰

é‚£ä¹ˆå¯ä»¥è¯´ï¼Œæ—§çš„æ–¹å¼æš´éœ²äº†ä¸¤ç‚¹é—®é¢˜ï¼š

* **è‡ªé¡¶å‘ä¸‹éå†ï¼Œä¸èƒ½åœã€‚**
* **Reacté•¿æ—¶é—´çš„æ‰§è¡Œè€½è¯¯äº†æµè§ˆå™¨å·¥ä½œã€‚**

###  vdomè¿›åŒ–æˆä¸ºFiber
`Fiber`å¯ä»¥ç†è§£ä¸ºå°†ä¸Šè¿°æ•´ä¸ª`reconciliation`å·¥ä½œæ‹†åˆ†äº†ï¼Œç„¶åé€šè¿‡é“¾è¡¨ä¸²äº†èµ·æ¥ï¼Œå˜æˆäº†ä¸€ä¸ªä¸ªå¯ä»¥ä¸­æ–­/æŒ‚èµ·/æ¢å¤çš„ä»»åŠ¡å•å…ƒã€‚å¹¶ä¸”ç»“åˆæµè§ˆå™¨æä¾›çš„`requestIdleCallback` APIï¼ˆæœ‰å…´è¶£å¯ä»¥äº†è§£ï¼‰è¿›è¡ŒååŒåˆä½œã€‚

> **Fiberæ ¸å¿ƒæ˜¯å®ç°äº†ä¸€ä¸ªåŸºäºä¼˜å…ˆçº§å’ŒrequestIdleCallbackçš„å¾ªç¯ä»»åŠ¡è°ƒåº¦ç®—æ³•**ã€‚å®ƒåŒ…å«ä»¥ä¸‹ç‰¹æ€§ï¼š([å‚è€ƒï¼šfiber-reconciler](https://reactjs.org/docs/codebase-overview.html#fiber-reconciler))

**ç›´ç™½çš„è¯´ï¼šå°±ä¸€ç¢—é¢æ¡ï¼Œä¸€åŒç­·å­ï¼Œä»¥å‰Reactåƒçš„æ—¶å€™ï¼Œæµè§ˆå™¨åªèƒ½çœ‹ç€ï¼Œç°åœ¨å°±å˜æˆReactåƒä¸€å£æ¢æµè§ˆå™¨åƒä¸€å£ï¼Œä¸€ä¸‹å°±å’Œè°äº†ã€‚**

è€Œä¸”`Fiber`å°±æ˜¯æŒ‰ç…§`vdom`æ¥æ‹†åˆ†çš„ï¼Œä¸€ä¸ª`vdom`èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ª`Fiber`èŠ‚ç‚¹ï¼Œæœ€åå½¢æˆä¸€ä¸ªé“¾è¡¨ç»“æ„çš„`fiber tree`ï¼Œå¤§ä½“å¦‚å›¾ï¼š

 ![Image](https://s1.imagehub.cc/images/2021/11/21/fiber1.jpg)
 
childï¼šæŒ‡å‘å­èŠ‚ç‚¹çš„æŒ‡é’ˆ
siblingï¼šæŒ‡å‘å…„å¼ŸèŠ‚ç‚¹æŒ‡é’ˆ
returnï¼šæäº¤å˜åŠ¨ç»“æœï¼ˆeffectListï¼‰åˆ°æŒ‡å®šçš„ç›®æ ‡èŠ‚ç‚¹ï¼ˆå›¾ä¸­æ²¡æ ‡ç¤ºï¼Œä¸‹æ–‡ä¼šæœ‰åŠ¨æ€æ¼”ç¤ºï¼‰

**æ‰€ä»¥è¯´`Fiber tree`å°±æ˜¯å¯åˆ‡ç‰‡çš„`vdom tree`éƒ½ä¸ä¸ºè¿‡ã€‚**

### é‚£ä¹ˆ`vdom`è¿˜å­˜åœ¨ä¹ˆï¼Ÿ

è¿™ä¸ªé—®é¢˜æˆ‘æ€è€ƒäº†å¾ˆä¹…ï¼Œè¯·åŸè°…è¿™æ–¹é¢çš„æºç æˆ‘è¿˜æ²¡çœ‹é€ï¼Œæˆ‘ç°åœ¨é€šè¿‡æŸ¥é˜…å¤šç¯‡ç›¸å…³çš„æ–‡ç« ï¼Œå¾—å‡ºäº†ä¸€ä¸ªæˆ‘èƒ½æ¥å—ï¼Œé€»è¾‘èƒ½è‡ªæ´½çš„è§£é‡Š:

**`Fiber`å‡ºæ¥ä¹‹åï¼Œ`vdom`çš„ä½œç”¨åªæ˜¯ä½œä¸ºè“æœ¬è¿›è¡Œæ„å»º`Fiber`æ ‘ã€‚**

em~ï¼Œé¾™ç ç†Ÿæ‚‰å§ï¼Œ`vdom`å°±å¥½åƒæ˜¯è¶…çº§èµ›äºšäºº1ä¹‹å‰å¤Ÿç”¨äº†ï¼Œç°åœ¨ä¸è¡Œäº†ï¼Œè¿›åŒ–åˆ°äº†è¶…çº§èµ›äºšäºº2ï¼Œå³`Fiber`ã€‚

## Fiberæ˜¯å¦‚ä½•å·¥ä½œçš„

é¦–å…ˆæˆ‘å·²ç»çŸ¥é“ï¼Œ`Fiber tree`æ˜¯ä¸€ä¸ªé“¾è¡¨ç»“æ„ï¼ŒReactæ˜¯é€šè¿‡å¾ªç¯å¤„ç†æ¯ä¸ª`Fiber`å·¥ä½œå•å…ƒï¼Œåœ¨ä¸€æ®µæ—¶é—´åå†äº¤è¿˜æ§åˆ¶æƒç»™æµè§ˆå™¨ï¼Œä»è€ŒååŒçš„åˆä½œï¼Œè®©é¡µé¢å˜å¾—æ›´åŠ æµç•…ã€‚

è¦å¼„æ¸…å‡½æ•°ç»„ä»¶æ€ä¹ˆæœ‰çš„**å»¶ç»­æ€§**çš„ç­”æ¡ˆå°±è—åœ¨äº†è¿™ä¸ª**å·¥ä½œå¾ªç¯**ä¸­ã€‚

### æ¢ç´¢ä¸€ä¸‹å·¥ä½œå¾ªç¯ï¼ŒworkLoop

ä¸ºäº†èƒ½å¤Ÿæ‘†è„±åˆå›°åˆé•¿çš„æºç åˆ†æï¼Œå¯ä»¥è¯•ç€å…ˆç®€å•çš„ç†è§£`workLoop`ã€‚

é¦–å…ˆLoopå•¥å‘¢ï¼Ÿ

**å·¥ä½œå•å…ƒ**ï¼Œå³`work`ã€‚

**`work`åˆå¯ä»¥ç²—ç•¥çš„åˆ†ä¸ºï¼š**

* **beginWork**ï¼šå¼€å§‹å·¥ä½œ
* **completeWork**ï¼šå®Œæˆå·¥ä½œ

é‚£ä¹ˆç»“åˆä¹‹å‰çš„Fiber treeï¼Œçœ‹ä¸€ä¸‹

 ![Image](https://s1.imagehub.cc/images/2021/11/21/fiber.jpg)

é‚£ä¹ˆçœ‹ä¸‹å¤§ä½“çš„è¿è½¬è¿‡ç¨‹ï¼š

 ![Image](https://s1.imagehub.cc/images/2021/11/21/ezgif.com-video-to-gif-1.gif)
 
 é‚£ä¹ˆé€šè¿‡åŠ¨ç”»æˆ‘åˆæ­¥äº†è§£äº†æ•´ä¸ª`workLoop`çš„æµè½¬è¿‡ç¨‹ï¼Œç®€å•æè¿°ä¸‹ï¼š
 
 1. è‡ªé¡¶`root`å‘ä¸‹ï¼Œæµè½¬å­èŠ‚ç‚¹`b1`
 2. b1å¼€å§‹`beginWork`ï¼Œå·¥ä½œç›®æ ‡æ ¹æ®æƒ…å†µdiffå¤„ç†ï¼Œè·å¾—å˜åŠ¨ç»“æœï¼ˆeffectListï¼‰ï¼Œç„¶ååˆ¤æ–­æ˜¯æ˜¯å¦æœ‰å­èŠ‚ç‚¹ï¼Œæ²¡æœ‰é‚£ç»“æŸå·¥ä½œ`completeWork`ï¼Œç„¶åæµè½¬åˆ°å…„å¼ŸèŠ‚ç‚¹`b2`
 3. `b2`å¼€å§‹å·¥ä½œï¼Œç„¶ååˆ¤æ–­æœ‰å­èŠ‚ç‚¹`c1`ï¼Œé‚£å°±æµè½¬åˆ°`c1`
 4. `c1`å·¥ä½œå®Œäº†ï¼Œ`completeWork`è·å¾—effectListï¼Œå¹¶æäº¤ç»™`b2`
 5. ç„¶å`b2`å®Œæˆå·¥ä½œï¼Œæµè½¬ç»™`b3`,é‚£ä¹ˆ`b3`å°±æŒ‰ç…§è¿™å¥—è·¯å­ï¼Œå¾€ä¸‹æ‰§è¡Œäº†ï¼Œæœ€åæ‰§è¡Œåˆ°äº†æœ€åº•éƒ¨`d2`
 6. æœ€åéšç€å…‰æ ‡çš„è·¯çº¿ï¼Œä¸€è·¯æ•´åˆå„èŠ‚ç‚¹çš„`effectList`ï¼Œæœ€åæŠµè¾¾`Root`èŠ‚ç‚¹ï¼Œç¬¬1é˜¶æ®µ-`reconciliation`ç»“æŸï¼Œå‡†å¤‡è¿›å…¥`Commit`é˜¶æ®µ

### å†è¿›ä¸€æ­¥ï¼Œâ€œå»¶ç»­â€çš„ç­”æ¡ˆå°±å¿«æµ®å‡ºæ°´é¢äº†

æˆ‘ä»¬å·²ç»å¤§è‡´çš„äº†è§£äº†`workLoop`ï¼Œä½†è¿˜ä¸èƒ½è§£é‡Šä¸ºä»€ä¹ˆå‡½æ•°ç»„ä»¶å¦‚ä½•â€œå»¶ç»­â€çš„ï¼Œæˆ‘ä»¬è¿˜è¦å†æ·±å…¥äº†è§£ï¼Œé‚£ä¹ˆå†ç»†è‡´ä¸€ç‚¹åˆ†è§£`workLoop`ï¼Œå®é™…ä¸Šæ˜¯è¿™æ ·çš„ï¼š

![test.gif](https://i.loli.net/2021/11/21/sCh17rwUebTpEXy.gif)

**æè¿°ä¸€ä¸‹è¿‡ç¨‹ï¼š**

1. æ ¹æ®`current fiber tree`cloneå‡º`workinProgress fiber tree`ï¼Œæ¯cloneä¸€ä¸ª`workinProgress fiber`éƒ½ä¼šå°½å¯èƒ½çš„å¤ç”¨å¤‡ç”¨`fiber`èŠ‚ç‚¹ï¼ˆæ›¾ç»çš„`current fiber`ï¼‰
2. å½“æ„å»ºå®Œæ•´ä¸ª`workinProgress fiber tree`çš„æ—¶å€™ï¼Œ`current fiber tree`å°±ä¼šé€€ä¸‹å»ï¼Œä½œä¸ºå¤‡ç”¨`fiber`èŠ‚ç‚¹æ ‘ï¼Œç„¶åâ€œ`workinProgress fiber tree`å°±ä¼šæ‰¶æ­£ï¼Œæˆä¸ºæ–°çš„`current fiber tree`
3. ç„¶åå°±å°†æ”¶é›†å®Œå˜åŠ¨ç»“æœï¼ˆ`effect list`ï¼‰çš„æ–°`current fiber tree`ï¼Œé€å»`commit`é˜¶æ®µï¼Œä»è€Œæ›´æ–°ç”»é¢

**å…¶ä¸­å‡ ä¸ªç‚¹æˆ‘è¦æ³¨æ„ï¼š**

* æ„å»º`workinProgress fiber tree`çš„è¿‡ç¨‹ï¼Œå°±æ˜¯`diff`çš„è¿‡ç¨‹ï¼Œä¸»è¦çš„å·¥ä½œéƒ½æ˜¯å‘ç”Ÿåœ¨`workinProgress fiber`ä¸Šï¼Œæœ‰å˜åŠ¨å°±ä¼šç»´æŠ¤ä¸€ä¸ª`effect list`,å½“å®Œæˆå·¥ä½œçš„æ—¶å€™å°±ä¼šæäº¤æ ¼ç»™`return`æ‰€æŒ‡å‘çš„èŠ‚ç‚¹ã€‚
* é€€ä½çš„`current fiber tree`,ä¼šåŒ–ä½œä¸‹ä¸€æ¬¡æ„å»º`workinProgress fiber tree`çš„åŸæ–™ï¼Œæœ€å¤§ç¨‹åº¦èŠ‚çº¦äº†æ€§èƒ½ï¼Œè¿™æ ·å‘¨è€Œå¤å§‹ã€‚
* æ”¶é›†åˆ°çš„`effect list`åªä¼šå…³æ³¨æœ‰æ”¹åŠ¨çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”ä»æœ€æ·±å¤„å¾€å‰æ’åˆ—ï¼Œè¿™ä¹Ÿå°±å¯¹åº”ä¸Šäº†ï¼Œåˆ·æ–°é¡ºåºæ˜¯å­èŠ‚ç‚¹åˆ°çˆ¶èŠ‚ç‚¹ã€‚

### åŒfiberæ ‘å°±æ˜¯é—®é¢˜å…³é”®

**æœ‰ä¸¤ä¸ªé˜¶æ®µï¼š**

* é¦–æ¬¡æ¸²æŸ“ï¼šç›´æ¥å…ˆæŠŠ`current fiber tree`æ„å»ºå‡ºæ¥
* æ›´æ–°æ¸²æŸ“ï¼š å»¶ç»­`current fiber tree`æ„å»º`workinProgress fiber tree`

### èœ•å˜ä¹‹ä¸­å¿…æœ‰å»¶ç»­

æ›´æ–°é˜¶æ®µï¼Œä¸¤æ£µ`fiber`æ ‘å¦‚åŒç”Ÿä¸€èˆ¬ï¼Œ`current fiber`ä¸`workinProgress fiber`ä¹‹é—´ç”¨`alternate`è¿›è¡Œäº†å…³è”ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥åœ¨å¤„ç†`workinProgress fiber`å·¥ä½œçš„æ—¶å€™ï¼Œèƒ½å¤Ÿè·å¾—`current fiber`çš„ä¿¡æ¯ï¼Œé™¤éæ˜¯å…¨æ–°çš„ï¼Œé‚£å°±é‡æ–°åˆ›å»ºã€‚

æ¯æ„å»ºä¸€ä¸ª`workinProgress fiber`ï¼Œå¦‚æœè¿™ä¸ª`fiber`å¯¹åº”çš„èŠ‚ç‚¹æ˜¯ä¸€ä¸ªå‡½æ•°ç»„ä»¶ï¼Œå¹¶ä¸”è¿‡`alternate`è·å¾—`current fiber`ï¼Œé‚£ä¹ˆå°±è¿›è¡Œå»¶ç»­ï¼Œæ‰¿è½½å…¶ç²¾åçš„ä¾¿æ˜¯`current fiber memoizedState`

### å»¶ç»­çš„ç²¾åå°½åœ¨`memoizedState`

**é¦–æ¬¡æ¸²æŸ“æ—¶**

ä¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œæˆ‘ä»¬åœ¨å‡½æ•°ç»„ä»¶çš„hooksï¼Œæ¯æ‰§è¡Œä¸€ä¸ªç§ç±»hooksï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªå¯¹åº”è¯¥ç§ç±»çš„hookå¯¹è±¡ï¼Œç”¨æ¥ä¿å­˜ä¿¡æ¯ã€‚

 * useState å¯¹åº” stateä¿¡æ¯
*  useEffect å¯¹åº” effect å¯¹è±¡
 * useMemo å¯¹åº” ç¼“å­˜çš„å€¼å’Œdeps
 * useRef å¯¹åº” ref å¯¹è±¡
 * ...

è¿™äº›ä¿¡æ¯éƒ½ä¼šä»¥é“¾è¡¨çš„å½¢å¼ä¿å­˜åœ¨`current fiber`çš„`memoizedState`ä¸­


**æ›´æ–°æ¸²æŸ“æ—¶**

æ¯æ¬¡æ„å»ºå¯¹åº”çš„æ˜¯**å‡½æ•°ç»„ä»¶**çš„`workinProgress fiber`æ—¶ï¼Œéƒ½ä¼šä»å¯¹åº”çš„`current fiber`ä¸­å»¶ç»­è¿™ä¸ª**ä»¥é“¾è¡¨ç»“æ„å­˜å‚¨çš„hooksä¿¡æ¯**ã€‚

å¦‚è¯¥å‡½æ•°ç»„ä»¶ï¼š

```js
export default function Test() {
 const [info1, setInfo1] = useState(0);
 useEffect(() => {}, [info1]);
 const ref = useRef();
 const [info2, setInfo2] = useState(0);
 const [info3, setInfo3] = useState(0);
 return (
	 <div>
		<div ref={ref}> {`${info1}${info2}${info3}`}</div>
	 </div>
 );
}
```

é‚£ä¹ˆ`hooks`çš„å»¶ç»­å°±å¦‚ä¸‹å›¾è¿™æ ·ï¼š

![hooksList.jpg](https://i.loli.net/2021/11/21/usa9mKhyp2EROC4.jpg)

é€šè¿‡é“¾è¡¨çš„é¡ºåºå»å»¶ç»­ï¼Œå¦‚æœå…¶ä¸­çš„ä¸€ä¸ª`hooks`å†™åœ¨æ¡ä»¶è¯­å¥ä¸­ï¼Œ

```js
export default function Test() {
 const [info1, setInfo1] = useState(0);
 let ref;
 useEffect(() => {
 setInfo1(info1+1)
 }, [info1]);
 if(info1==0){
 	ref = useRef();
 }
 const [info2, setInfo2] = useState(0);
 const [info3, setInfo3] = useState(0);
 return (
	 <div>
		<div ref={ref}> {`${info1}${info2}${info3}`}</div>
	 </div>
 );
}
```

é‚£ä¹ˆå°±ä¼šç ´åå»¶ç»­é¡ºåºï¼Œè·å¾—ä¿¡æ¯å°±ä¼šé©´å”‡ä¸å¯¹é©¬å˜´ï¼Œå°±åƒè¿™æ ·ï¼š

![QQæˆªå›¾20211121210010.jpg](https://i.loli.net/2021/11/21/7289BbCqdOnLRuI.jpg)

**æ‰€ä»¥è¿™å°±æ˜¯ä¸èƒ½æŠŠ`hooks`å†™åœ¨æ¡ä»¶è¯­å¥ä¸­çš„åŸå› **

**è€Œè¿™å°±æ˜¯Hooksèƒ½å¤Ÿå»¶ç»­çš„å¥¥ç§˜ï¼Œä½œä¸ºæ”¯æ’‘å…¶å®ç°å„ç§åŠŸèƒ½ï¼Œä»è€Œä¸classç»„ä»¶ç›¸åª²ç¾çš„å‰æåŸºç¡€ã€‚**

# hooksæ•´çš„é‚£äº›æ´»å„¿
## äº†è§£ä¸€ä¸‹capture valueä»¥åŠé—­åŒ…é™·é˜±

`capture value`é¡¾åæ€ä¹‰ï¼Œâ€œæ•è·çš„çš„å€¼â€ï¼Œå‡½æ•°ç»„ä»¶æ‰§è¡Œä¸€æ¬¡å°±ä¼šäº§ç”Ÿä¸€ä¸ªé—­åŒ…ï¼Œå°±å¥½åƒä¸€ä¸ªå¿«ç…§ï¼Œ
è¿™è·Ÿæˆ‘ä»¬ä¸Šé¢åˆ†æè¯´çš„â€œå…³è”renderç»“æœâ€æˆ–è€…â€œé‚£ä¸€åˆ»å¿«ç…§â€å‘¼åº”ä¸Šäº†ã€‚

å½“`capture value`é‡ä¸Š`hooks`å‡ºç°äº†å› ä½¿ç”¨â€œè¿‡æœŸå¿«ç…§â€è€Œäº§ç”Ÿçš„é—®é¢˜ï¼Œé‚£å°±ç§°ä¸º**é—­åŒ…é™·é˜±**ã€‚

ä¸è¿‡å«ä»€ä¹ˆä¸é‡è¦ï¼Œå½’æ ¹èŠ‚ç‚¹éƒ½æ˜¯â€œè¿‡æœŸå¿«ç…§â€çš„é—®é¢˜ï¼Œè€Œåœ¨`useEffect`ä¸­çš„æš´éœ²çš„é—®é¢˜æœ€ä¸ºæ˜æ˜¾ã€‚

å…ˆä¸¾ä¸ªğŸŒ°ï¼š
```js
let B = (props) => {
  const { info } = props;
  const [count,setCount] = useState(0);
  useEffect(()=>{
    setInterval(()=>{
      //è¿™æ‰æ˜¯dispatchå‡½æ•°æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼
      setCount((old)=>{
        return old+1;
      })
    },1000)
  },[])
  useEffect(()=>{
      setInterval(()=>{
          console.log("infoä¸ºï¼š"+info+" countä¸ºï¼š"+count)
      },1000)
  },[])
  return <div></div>
}


let A = (props) => {
  const [info,setInfo] = useState(0);
  useEffect(()=>{
    setInterval(()=>{
      //è¿™æ‰æ˜¯dispatchå‡½æ•°æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼
      setInfo((old)=>{
        return old+1;
      })
    },1000)
  },[])
  return <div>
    <B info={info}></B>
    {info}
    </div>
}

export default function App() {
  return (
    <div>
      <A>
      </A>
    </div>
  );
}
```
è¿™ç§logå‡ºæ¥çš„ä¸€ç›´éƒ½æ˜¯`infoï¼š0 countï¼š0`ï¼Œå¾ˆæ˜¾ç„¶ä½¿ç”¨çš„å…³è”çš„â€œè¿‡æœŸå¿«ç…§â€ä¸­çš„æ•°æ®ã€‚

è§£å†³åŠæ³•ï¼š

é€šè¿‡`useRef`è·å¾—`ref`å¯¹è±¡

`ref`çš„ç»“æ„æ˜¯è¿™æ ·çš„ï¼š

```js
{
	current:null
}
```
æˆ‘ä»¬æŠŠéœ€è¦æ‰˜ç®¡çš„æ•°æ®èµ‹å€¼ç»™`current`,å€¼å¾—ä¸€æçš„ä½ åªèƒ½èµ‹å€¼ç»™`current`ï¼Œ**`ref`å¯¹è±¡æ˜¯ä¸æ”¯æŒæ‰©å±•çš„**ã€‚

ç„¶åæˆ‘ä»¬é‡å†™ä¸€ä¸‹ä»£ç ï¼š

```js
let B = (props) => {
  const { info } = props;
  const [count,setCount] = useState(0);
  const refInfoFromProps = useRef();
  const refCountFromProps = useRef();
  refInfoFromProps.current = info;
  refCountFromProps.current = count;
  useEffect(()=>{
    setInterval(()=>{
      //è¿™æ‰æ˜¯dispatchå‡½æ•°æ­£ç¡®çš„ä½¿ç”¨æ–¹å¼
      setCount((old)=>{
        return old+1;
      })
    },1000)
  },[])
  useEffect(()=>{
      setInterval(()=>{
          console.log("infoä¸ºï¼š"+refInfoFromProps.current+" countä¸ºï¼š"+refCountFromProps.current)
      },1000)
  },[])
  return <div></div>
}
```

è¿™æ ·å°±èƒ½æ¯æ¬¡éƒ½è®¿é—®æœ€æ–°çš„æ•°æ®äº†ã€‚

å½“ç„¶è¿˜æœ‰å¾ˆå¤šåˆ«çš„åŠæ³•ï¼Œæ¯”å¦‚ä½¿ç”¨`useReducer`ï¼Œæœ‰å…´è¶£å¯ä»¥ç ”ç©¶ä¸€ä¸‹ã€‚

## useStateçš„äº‹å„¿

### è¿™æ ·è®¾ç½®åˆ·æ–°ä¹ˆï¼Ÿ

å…ˆçœ‹ä¸‹è¿™æ®µä»£ç 

```js
let A = ((props) => {
  const [count,setCount] = useState({a:1})
  
  return <div onClick={()=>{
    count.a = Date.now();
    setCount(count)
  }}>
  	æµ‹è¯•æ˜¯å¦åˆ·æ–°
  </div>
})
```

å½“æˆ‘ç‚¹å‡»ä¹‹åé™¤æ³•äº†`setCount`ï¼Œè¯·é—®åˆ·æ–°ä¹ˆï¼Ÿ

ç­”æ¡ˆæ˜¯**ä¸åˆ·æ–°**ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä½¿ç”¨Reactçš„æ—¶å€™ï¼Œå¿ƒé‡Œä¸€ç‚¹å¸¸æé†’ä¸€å¥è¯ï¼Œå°±æ˜¯ï¼š

**ä¸å¯å˜å€¼ï¼Œä¸å¯å˜å€¼ï¼Œä¸å¯å˜å€¼**

ä¸Šé¢çš„ä»£ç é—®é¢˜ä¸»è¦ä¸¤ç‚¹ï¼š

* ç›´æ¥çš„ä¿®æ”¹äº†stateï¼Œè¿™æ ·ç ´åäº†ä¸å¯å˜å€¼çš„è§„çŸ©ï¼Œä½ åº”è¯¥é€šè¿‡Object.assignæˆ–è€…æ‰©å±•è¿ç®—æ³•æ¥é‡æ–°åˆ›å»ºä¸€ä¸ªå¯¹è±¡è¿›è¡Œèµ‹å€¼ã€‚
* Reactå†…éƒ¨ä¼šé’ˆå¯¹ä¼ å…¥çš„å‚æ•°è¿›è¡Œæµ…æ¯”è¾ƒï¼Œå¼•ç”¨ç±»å‹çš„æ•°æ®æ¯”è¾ƒçš„æ˜¯å…¶æŒ‡å‘çš„åœ°å€ï¼Œè€Œä¸æ˜¯å†…å®¹ï¼Œåˆ‡è®°ã€‚

æ­£ç¡®çš„å†™æ³•

```js
let A = ((props) => {
  const [count,setCount] = useState({a:1})

  return <div onClick={()=>{
    setCount({...count,a:Date.now()})
  }}>
    æµ‹è¯•æ˜¯å¦åˆ·æ–°
  </div>
})
```

### useStateå’ŒsetStateä¸å¤ªä¸€æ ·

`useState`çš„`set`å‡½æ•°è·Ÿç±»ç»„ä»¶çš„setStateå‘½åå¾ˆåƒï¼Œä¼šè®©æœ‰ç§é”™è§‰ä»–ä¿©ä¸€æ ·ï¼Œå…¶å®ä¸ç„¶ï¼Œå‰è€…å®é™…ä¸Šæ˜¯ä¸€ä¸ª`dispath`ï¼Œå› ä¸º`useState`å†…éƒ¨æ˜¯åŸºäº`useReducer`å®ç°çš„ã€‚

**å…¶ä¸­æœ‰ä¸‰ç‚¹ä¸åŒå€¼å¾—æŒ‡å‡ºï¼š**

`setState`:
 1. **ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°**ï¼Œå¯ä»¥åœ¨çŠ¶æ€å€¼è®¾ç½®ç”Ÿæ•ˆåè¿›è¡Œå›è°ƒï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™é‡Œé¢æ‹¿åˆ°æœ€æ–°çš„çŠ¶æ€å€¼ã€‚
 2. **setStateå…·å¤‡æµ…åˆå¹¶åŠŸèƒ½**ï¼Œæ¯”å¦‚stateæ˜¯`{a:1,b:2,c:{e:0}}`,`setState({c:{f:0},d:4})`,`state`å°±ä¼šåˆå¹¶æˆ`{a:1,b:2,c:{f:0},d:4}`
 3. **`setState`è®¾ç½®çŠ¶æ€å°±ä¼šå¼•å‘åˆ·æ–°**ï¼Œå³ä½¿è®¾ç½®çš„æ˜¯ç›¸åŒçš„å€¼ä¹Ÿä¸€æ ·ï¼Œé™¤éç”¨`PureComponent`å®ç°æ‰èƒ½è§£å†³

 `set`å‡½æ•°
 1. **æ²¡æœ‰ç¬¬äºŒä¸ªå‚æ•°**ï¼Œä½†æ˜¯å¯ä»¥å€ŸåŠ©`useEffect`ç»„åˆå®ç°,ä¹Ÿè¿˜å¥½
 2. **æ²¡æœ‰åˆå¹¶åŠŸèƒ½**ï¼Œè®¾ç½®å•¥å°±æ˜¯å•¥ã€‚ã€‚ã€‚,ä¸è¿‡è‡ªå·±åŠ¨æ‰‹ä¼˜åŒ–ä¸€ä¸‹ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚
 3. **è®¾ç½®ç›¸åŒçš„çŠ¶æ€æ˜¯ä¸ä¼šè§¦å‘åˆ·æ–°çš„**ï¼Œè¿™ä¸€ç‚¹æ— éœ€è¿›è¡Œé…ç½®ã€‚

è¿˜æœ‰ä¸€ä¸ªå€¼å¾—å¼ºè°ƒçš„ä¸€ç‚¹çš„é—®é¢˜ï¼Œæ¥ä¸‹æ¥æ·±å…¥è®¨è®ºã€‚

### `useState`çš„`set`å‡½æ•°æ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„ï¼Ÿ`setState`æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥çš„ï¼Ÿ

ç­”æ¡ˆæƒŠäººçš„ä¸€è‡´ï¼Œå³ï¼š

**å¤§éƒ¨åˆ†æ—¶å€™å¼‚æ­¥ï¼Œæœ‰äº›æ—¶å€™åŒæ­¥**

å…·ä½“ä»€ä¹ˆæ—¶å€™åŒæ­¥å‘¢ï¼Ÿå°±æ˜¯

[å¦‚æœæ˜¯ç”±Reactå¼•å‘çš„äº‹ä»¶å¤„ç†ï¼ˆæ¯”å¦‚é€šè¿‡onClickå¼•å‘çš„äº‹ä»¶å¤„ç†ï¼‰ï¼Œè°ƒç”¨setStateä¸ä¼šåŒæ­¥æ›´æ–°this.stateï¼Œé™¤æ­¤ä¹‹å¤–çš„setStateè°ƒç”¨ä¼šåŒæ­¥æ‰§è¡Œthis.state](https://zhuanlan.zhihu.com/p/26069727#:~:text=%E5%A6%82%E6%9E%9C%E6%98%AF%E7%94%B1React%E5%BC%95%E5%8F%91%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%EF%BC%88%E6%AF%94%E5%A6%82%E9%80%9A%E8%BF%87onClick%E5%BC%95%E5%8F%91%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%EF%BC%89%EF%BC%8C%E8%B0%83%E7%94%A8setState%E4%B8%8D%E4%BC%9A%E5%90%8C%E6%AD%A5%E6%9B%B4%E6%96%B0this.state%EF%BC%8C%E9%99%A4%E6%AD%A4%E4%B9%8B%E5%A4%96%E7%9A%84setState%E8%B0%83%E7%94%A8%E4%BC%9A%E5%90%8C%E6%AD%A5%E6%89%A7%E8%A1%8Cthis.state)

ä¸ä¿¡ï¼Œé‚£çœ‹ä¸‹ä»£ç ï¼š

```js
export default function Test() {
  const [info1, setInfo1] = useState(0);
  const [info2, setInfo2] = useState(0);
  const ref1 = useRef();
  const ref2 = useRef();
  ref1.current = info1;
  ref2.current = info2;
  useEffect(() => {
    setInfo1(ref1.current + 1);
    setInfo1(ref1.current + 1);
    setInfo1(ref1.current + 1);
    console.log("info1:"+ref2.current); // info1:0
    setTimeout(() => {
      setInfo2(ref2.current + 1);
      setInfo2(ref2.current + 1);
      setInfo2(ref2.current + 1);
      console.log("info2:"+ref2.current);// åŒæ­¥è¾“å‡º info2:3
    });
  }, []);
  return <div>{info1}</div>;
}
```
è¾“å‡ºçš„æ—¥å¿—æ˜¯:
`info1:0`
`info2:3`

æ‰€æœ‰è¿™ä¸€ç‚¹ä¸Šå°±è·Ÿ`setState`ä¸€æ ·äº†ä¹ˆï¼Œæ‰€ä»¥å†è¯´`useState`çš„`set`å‡½æ•°æ˜¯å¼‚æ­¥è¿˜æ˜¯åŒæ­¥çš„æ—¶å€™ï¼ŒçŸ¥é“æ€ä¹ˆè¯´äº†å§ã€‚

## useEffectçš„äº‹å„¿

`useEffect`æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªeffectæ‰§è¡Œçš„å›è°ƒå‡½æ•°ï¼Œä¸€ä¸ªæ˜¯æ˜¯ä¾èµ–æ•°ç»„

åŒæ—¶`useEffect`å¯ä»¥å†™å¤šä¸ªï¼Œè¿™æ ·å°±å¯ä»¥**æŒ‰ç…§ä¸šåŠ¡ç‹¬ç«‹æ‹†åˆ†**ï¼Œåšåˆ°**å…³æ³¨ç‚¹åˆ†ç¦»**

### ç”Ÿå‘½å‘¨æœŸ

useEffectæ˜¯å‡½æ•°ç»„ä»¶å®ç°ç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„é‡è¦æ‰‹æ®µ

å¯ä»¥æ¨¡æ‹Ÿçš„ç”Ÿå‘½å‘¨æœŸåˆ†åˆ«æ˜¯ï¼š

* componentDidMount
* componentWillUnmount
* componentDidUpdate

ä»£ç å¦‚ä¸‹ï¼š

```js
  useEffect(() => {
    // ç›¸å½“äº componentDidMount
    return () => {
      // ç›¸å½“äº componentWillUnmount
    }
  }, [])
 
  useEffect(() => {
    // ç›¸å½“äº componentDidUpdate
  })
```

### useEffectçš„æ¸…é™¤å‡½æ•°çš„æ‰§è¡Œæ—¶æœº

é¦–å…ˆ**æ¸…é™¤å‡½æ•°**æ‰§è¡Œæœ‰ä¸¤ç§æƒ…å†µï¼š

* **ä¸€ä¸ªæ˜¯å¸è½½çš„æ—¶å€™**ï¼Œè¿™ä¸ªä¼—æ‰€å‘¨çŸ¥ã€‚
* **ä¸€ä¸ªæ˜¯effecté‡æ–°æ‰§è¡Œçš„æ—¶å€™**ï¼Œä¹Ÿä¼šæ‰§è¡Œï¼Œè¿™ç‚¹å¤§å®¶è¦æ³¨æ„ï¼Œå®¹æ˜“é©¬è™

ç„¶åå†çœ‹ä¸‹è¿™æ®µä»£ç 

```js
useEffect(
    () => {
      if (flag) {
        ...
        return () => {
          ...
          console.log("test")
        }
      }
    },
    [flag]],
  )
```
è¯·é—®ï¼šå½“`flag`ä»`true`è®¾ç½®æˆäº†`false`ï¼Œè¿™ä¸ª`return`çš„æ¸…é™¤å‡½æ•°ä¼šæ‰§è¡Œä¹ˆï¼Ÿ

å†ç®€å•ç‚¹

```js
useEffect(
    () => {
        ...
        return () => {
          ...
          console.log("test")
        }
    },
    [flag]],
  )
```

è¯·é—®æ‰§è¡Œä¹ˆï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼š**æ‰§è¡Œ**

ä½ å¯ä»¥è®°ä½ä¸€ä¸ªé“å¾‹ï¼š

**å½“effecté‡æ–°æ‰§è¡Œçš„æ—¶å€™ï¼Œä¼šæ¸…é™¤ä¸Šä¸€æ¬¡effect**

### useEffectå’ŒuseLayoutEffectåŒºåˆ†

> useEffectæ˜¯å¼‚æ­¥çš„ï¼ŒuseLayoutEffectæ˜¯åŒæ­¥çš„
> æ‰€è°“çš„å¼‚æ­¥å°±æ˜¯åˆ©ç”¨`requestIdleCallback`ï¼Œåœ¨æµè§ˆå™¨ç©ºé—²æ—¶é—´æ‰§è¡Œä¼ å…¥çš„`callback`ï¼Œä¹Ÿå°±æ˜¯ç»§ç»­å¤„ç†jsé€»è¾‘
> å¤§éƒ¨åˆ†æƒ…å†µæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä½†æ˜¯å½“æœ‰è€—æ—¶çš„é€»è¾‘ï¼Œ`useLayoutEffect`å°±ä¼šé€ æˆæ¸²æŸ“é˜»å¡

[å…ˆè´´å‡ºä¸€æ®µä»£ç ï¼Œè¿™æ˜¯æˆ‘åœ¨ç½‘ä¸Šé‡åˆ°äº†å¾ˆæœ‰è¶£çš„ä¾‹å­ã€‚](https://imweb.io/topic/5cd845cadcd62f86299fcd76#:~:text=useEffect%E6%98%AF%E5%BC%82%E6%AD%A5%E7%9A%84%EF%BC%8CuseLayoutEffect%E6%98%AF%E5%90%8C%E6%AD%A5%E7%9A%84)

```js
function TestEffectApi() {
  const [lapse, setLapse] = useState(0)
  const [running, setRunning] = useState(false)

  useEffect(
    () => {
      if (running) {
        const startTime = Date.now() - lapse
        const intervalId = setInterval(() => {
          setLapse(Date.now() - startTime)
        }, 2)
        console.log(intervalId)
        return () => {
          clearInterval(intervalId)
        }
      }
    },
    [running],
  )

  function handleRunClick() {
    setRunning(r => !r)
  }

  function handleClearClick() {
    setRunning(false)
    setLapse(0)
  }

  return (
    <div>
      <label>{lapse}ms</label>
      <button onClick={handleRunClick}>
        {running ? 'æš‚åœ' : 'å¼€å§‹'}
      </button>
      <button onClick={handleClearClick}>
        æš‚åœå¹¶æ¸…0
      </button>
    </div>
  )
}
```

é€šè¿‡ä»£ç å¯ä»¥çœ‹å‡ºï¼Œå½“æˆ‘ç‚¹å‡»â€œæš‚åœå¹¶æ¸…0â€æŒ‰é’®çš„æ—¶å€™ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸¤ä¸ªçŠ¶æ€ä¸€ä¸ª`running`å’Œ`lapse`ï¼Œå‰è€…æ§åˆ¶å®šæ—¶å™¨è¿è¡Œï¼Œåè€…æ§åˆ¶æ•°æ®æ˜¾ç¤ºï¼Œè€Œç‚¹å‡»ä¹‹åçš„é¢„æœŸæ˜¯ï¼šå®šæ—¶å™¨å…³é—­ï¼ŒåŒæ—¶æ˜¾ç¤ºçš„æ•°æ®ä¸ºâ€œ0â€ï¼Œä½†æ˜¯å®é™…æƒ…å†µå´æ˜¯å¶å‘å‡ºç°æ˜¾ç¤ºä¸ä¸ºâ€œ0â€çš„æƒ…å†µ

**åŸå› ï¼š**

å› ä¸º`useEffect`æ˜¯å¼‚æ­¥çš„ï¼Œå½“é€šè¿‡è®¾ç½®`running`å…³é—­å®šæ—¶å™¨å’Œè®¾ç½®`lapse`ä¸ºâ€œ0â€æ—¶ï¼Œå¹¶æ²¡æœ‰ç¬¬ä¸€æ—¶é—´å…³é—­å®šæ—¶å™¨ï¼Œè€Œæ˜¯é˜´å·®é˜³é”™çš„å‡ºç°äº†ä¸€ç§æƒ…å†µï¼š`lapse`å·²ç»è®¾ç½®ä¸ºé›¶ï¼Œå®šæ—¶å™¨è¿˜æ²¡å…³é—­å°±è¦å…³é—­çš„è¿™ä¸€éœï¼Œåˆä¸€æ¬¡çš„æ‰§è¡Œäº†ï¼Œä¾¿å‡ºç°äº†è¿™ç§é—®é¢˜ã€‚è€Œç”¨åŒæ­¥æ‰§è¡Œçš„`LayoutEffect`å°±æ²¡æœ‰è¿™ä¸ªé—®é¢˜

é€šè¿‡ä¸Šé¢è¿™ä¸ªä¾‹å­ï¼Œ`useEffect`å’Œ`LayoutEffect`çš„åŒºåˆ«åº”è¯¥èƒ½å¯è§ä¸€æ–‘äº†ã€‚

## useRefçœŸæœ‰ç”¨å•Š

useRefæ˜¯çœŸæœ‰ç”¨å•Šï¼Œå‡­å€Ÿâ€œè·¨æ¸²æŸ“å‘¨æœŸâ€ä¿å­˜æ•°æ®çš„èƒ½åŠ›ï¼Œå³æ‹¥æœ‰åœ¨æ•´ä¸ªç»„ä»¶ç”Ÿå‘½å‘¨æœŸåªç»´æŠ¤ä¸€ä¸ªå¼•ç”¨çš„ç‰¹æ€§ï¼Œå¯ä»¥è§£å†³å¾ˆå¤šé—®é¢˜ã€‚

ä¸ä½†å¯ä»¥ä¿å­˜`dom`èŠ‚ç‚¹è¿˜å¯ä»¥ä¿å­˜å…¶ä»–æ•°æ®ï¼Œæ¯”å¦‚ä¸Šé¢æåˆ°çš„è¿‡æœŸé—­åŒ…çš„é—®é¢˜ã€‚

é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªæœ‰è¶£çš„ç”¨å¤„ï¼Œå°±æ˜¯å¯ä»¥ç»“åˆ`forwardRef`å’Œ`useImperativeHandle`è¿™ä¸¤ä¸ªapiï¼Œè®©å‡½æ•°ç»„ä»¶å¯ä»¥åƒç±»ç»„ä»¶é‚£æ ·æš´éœ²å‡½æ•°ç»™å…¶ä»–èŠ‚ç‚¹ä½¿ç”¨

ä»£ç å¦‚ä¸‹:

```js
let A = forwardRef((props, ref) => {
  useImperativeHandle(ref, () => {
    return {
      test: () => {
        console.log("123")
      }
    }
  })
  const [info, setInfo] = useState(0);
  return <div>
    {info}
  </div>
})

export default function App() {
  const ref = useRef(null);
  return (
    <div onClick={() => {
      ref.current.test()
    }}>
      <A ref={ref}>
      </A>
    </div>
  );
}
```

åœ¨çˆ¶ç»„ä»¶ä¸­åˆ›å»ºä¸€ä¸ª`refï¼Œ`ç„¶åç»™åˆ°å­ç»„ä»¶çš„`A`
ä½†æ˜¯å­ç»„ä»¶æ˜¯å‡½æ•°ç»„ä»¶ï¼Œä¸èƒ½ç›´æ¥ç»™ï¼Œé‚£å°±ç”¨`forwardRef`è¿™ä¸ªHOCåŒ…è£…ä¸€ä¸‹ï¼Œå°±èƒ½æ”¶åˆ°äº†ï¼Œå¹¶ä½œä¸ºç»§`props`ä¹‹åç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥
æ‹¿åˆ°refä½œä¸º`useImperativeHandle`çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯è¿”å›æš´éœ²æ•°æ®çš„å‡½æ•°

`forwardRef`è¿™ä¸ªHocå®Œå…¨å¯ä»¥ä¸ç”¨ï¼Œæˆ‘æ”¹é€ ä¸€ä¸‹ä»£ç 

```js
let A = ((props) => {
  const {testRef} = props;
  useImperativeHandle(testRef, () => {
    return {
      test: () => {
        console.log("ok")
      }
    }
  })
  const [info, setInfo] = useState(0);
  return <div>
    {info}
  </div>
})

export default function App() {
  const ref = useRef(null);
  return (
    <div onClick={() => {
      ref.current.test()
    }}>
      <A testRef={ref}>
      </A>
    </div>
  );
}
```

è¿™ä¹ˆå†™ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œçœ‹ç€è¿˜ç®€æ´äº†ä¸å°‘ï¼Œä»…ä¾›å‚è€ƒã€‚

## useContextå¯ä»¥ä¸€å®šç¨‹åº¦çš„æ›¿ä»£ç¬¬ä¸‰æ–¹çš„æ•°æ®ç®¡ç†åº“

å…ˆè´´å‡ºå®Œæ•´å¯è¿è¡Œä»£ç 

```js
import {
  createContext,
  useContext,
  useReducer,
} from "react";
export const TestContext = createContext({})
const TAG_1 = 'TAG_1'

const reducer = (state, action) => {
  const { payload, type } = action;
  switch (type) {
    case TAG_1:
      return { ...state, ...payload };
      dedault: return state;
  }
};

export const A = (props) => {
  const [data, dispatch] = useReducer(reducer, { info: "æœ¬æ–‡ä½œè€…" });
  return (
    <TestContext.Provider value={{ data, dispatch }}>
      <B></B>
    </TestContext.Provider>
  );
};

let B = () => {
  const { dispatch, data } = useContext(TestContext);
  let handleClick = ()=>{
    dispatch({
        type: TAG_1,
        payload: {
          info: "é—²Dé˜¿å¼º",
        },
      })
  }
  return (
    <div>
      <input
        type="button"
        value="æµ‹è¯•context"
        onClick={handleClick}
      />
      {data.info}
    </div>
  );
};
```
**ä½¿ç”¨apiæœ‰ï¼š**

* **createContext**
* **useReducer**
* **useContext**

**å®ç°çš„æ­¥éª¤ï¼š**

* å‡½æ•°ç»„ä»¶A
	1. ä½¿ç”¨`createContext`apiåˆ›å»ºä¸€ä¸ª`TestContext`,è¿›è€Œä½¿ç”¨`Provider`
	2. ç„¶åä½¿ç”¨`useReducer`apiåˆ›å»ºä¸€ä¸ª`reducer`,å°†`reducer`è¿”å›çš„`data`, `dispatch`,é€šè¿‡`Provider`è¿›è¡Œå…±äº«

* å‡½æ•°ç»„ä»¶B
	1. åœ¨å…¶å†…éƒ¨ä½¿ç”¨`useContext`apiå¹¶ä¼ å…¥åˆ›å»ºå¥½çš„`TestContext`ï¼Œä»è€Œè·å¾—`data`,`dispatch`
	2. ä½¿ç”¨`data`ä¸­`info`å€¼ä½œä¸ºæ˜¾ç¤ºï¼Œé€šè¿‡ç‚¹å‡»äº‹ä»¶è°ƒç”¨`dispatch`è¿›è¡Œä¿®æ”¹ï¼Œçœ‹æ˜¯å¦

em~ï¼Œç›®å‰æ¥çœ‹å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ›¿ä»£æ•°æ®ç®¡ç†åº“ï¼Œå¯¹ï¼Œæ˜¯ä¸€å®šç¨‹åº¦ã€‚

## è‡ªå®šä¹‰hookä¸åŒäºä»¥å¾€å°è£…çš„å·¥å…·å‡½æ•°

è‡ªå®šä¹‰hookï¼Œå¤§æ¦‚æ˜¯è¿™ä¸ªæ ·å­çš„
```js
const useMousePosition = () => {
    const [position, setPosition] = useState({x: 0, y: 0 })
    useEffect(() => {
        const updateMouse = (e) => {
            setPosition({ x: e.clientX, y: e.clientY })
        }
        document.addEventListener('mousemove', updateMouse)
        return () => {
            document.removeEventListener('mousemove', updateMouse)
        }
    })
    return position
}
```

æˆ‘æ›¾çº ç»“è¿‡ä¸€ä¸ªé—®é¢˜ï¼Œå†™ä¸€ä¸ªè‡ªå®šä¹‰`hook`å’Œå•çº¯å°è£…ä¸€ä¸ªå‡½æ•°æœ‰åŒºåˆ«ä¹ˆï¼Ÿ

ç°åœ¨çœ‹æ¥ï¼Œç­”æ¡ˆæ˜¯è‚¯å®šï¼Œè‡³äºå¦‚ä½•å»åŒºåˆ†ï¼Œæˆ‘è§‰å¾—æ˜¯è¿™æ ·çš„ï¼š

è‡ªå®šä¹‰`hook`ä¸å…¶ä»–å·¥å…·å‡½æ•°çš„åŒºåˆ«å°±åœ¨äºå¯ä»¥ä½¿ç”¨å®˜æ–¹æä¾›çš„`hook`ï¼Œæ‹¥æœ‰è‡ªå·±çš„çŠ¶æ€ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¸ç”¨è¿™ä¸ªä¼˜åŠ¿ï¼Œé‚£ä¹ˆå°±è·Ÿæ™®é€šå‡½æ•°æ²¡å•¥åŒºåˆ«äº†ã€‚ã€‚ã€‚
å°±è¿™ä¸€æ‰‹ï¼Œæ‹†åˆ†å…±ç”¨é€»è¾‘ï¼Œé¿å…ä»£ç é‡å¤çš„å‘æŒ¥ç©ºé—´å°±å¤§äº†ä¸å°‘ã€‚

## å‡½æ•°ç»„ä»¶çš„æ€§èƒ½ä¼˜åŒ–çš„æ–¹å¼

### memo
memoæ˜¯ä¸€ä¸ªé«˜é˜¶ç»„ä»¶ï¼Œä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼š

```js
let A = memo((props) => {
  return <div >
    memoæµ‹è¯•
  </div>
})
```

å¾ˆå¤šæ–‡ç« è¯´`memo`ç›¸å½“äº`PureComponent`ï¼Œæˆ‘è§‰å¾—ä¸å¯¹ï¼Œæˆ‘æ›´æ„¿æ„è¿™ä¹ˆç†è§£:

**å‡½æ•°ç»„ä»¶æœ¬èº«å°±æœ‰è·Ÿ`PureComponent`æœ‰ç±»ä¼¼çš„èƒ½åŠ›**
**memoå¯¹æ ‡çš„åº”è¯¥æ˜¯ç±»ç»„ä»¶çš„`shouldComponentUpdate`**

æ¯”å¦‚ç”¨`PureComponent`åˆ›å»ºä¸€ä¸ªç±»ç»„ä»¶ï¼š
```js
class C extends PureComponent{
  state={
    a:1
  }
  render(){
    return <div onClick={
      ()=>{
        this.setState({
          a:1
        })
      }
    }>æµ‹è¯•ç»„ä»¶æ˜¯å¦åˆ·æ–°</div>
  }
}
```

ç‚¹å‡»è®¾ç½®çŠ¶æ€å˜é‡`a`ç›¸åŒçš„å€¼`1`ï¼Œé¡µé¢æ˜¯ä¸åˆ·æ–°çš„ï¼Œä½ ç”¨`Component`åˆ›å»ºçš„ç»„ä»¶æ˜¯åˆ·æ–°çš„
ä½†è¿™ç‚¹ï¼Œå‡½æ•°ç»„ä»¶æœ¬èº«å°±æœ‰äº†ï¼Œä¸ç”¨åˆ»æ„ä¸ºä¹‹ã€‚

è€Œ`memo`æœ€ä¸»è¦çš„å°±æ˜¯é¿å…å‡½æ•°ç»„ä»¶ä¸å¿…è¦çš„åˆ·æ–°ï¼Œè¿™ç‚¹è·Ÿ`shouldComponentUpdate`å¦‚å‡ºä¸€è¾™ã€‚

`shouldComponentUpdate`æ˜¯ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œä»£ç å¦‚ä¸‹ï¼š
```js
	...
	shouldComponentUpdate (nextProps, nextState) {
      if (nextProps.name === this.props.name) return false
      return true
    }
	...
```
`memo` çš„å®ç°ï¼Œä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°`propsAreEqual`ï¼Œä»£ç æ˜¯è¿™æ ·çš„ï¼š
```js
let propsAreEqual = (prevProps, nextProps)=>{
	// æ ¹æ®å…·ä½“ä¸šåŠ¡åˆ¤æ–­ä¼ å…¥çš„å‚æ•°æ˜¯å¦ç›¸å½“å†³å®šåˆ·æ–°
	// true è¡¨ç¤ºç›¸ç­‰ï¼Œä¸åˆ·æ–°ï¼Œå‡½æ•°ç»„ä»¶å°±ä¸ä¼šæ‰§è¡Œ
	// false è¡¨ç¤ºä¸ç­‰ï¼Œåˆ·æ–°ï¼Œå°±ä¼šæ‰§è¡Œ
	return false
}
let A = memo((props) => {
  return <div >
    memoæµ‹è¯•
  </div>
},propsAreEqual)
```

ä¸€ä¸ªå«â€œshouldComponentUpdateâ€ï¼Œ"æˆ‘å“ªèƒ½åˆ·æ–°ä¹ˆ"
ä¸€ä¸ªå«åšâ€œpropsAreEqualâ€ï¼Œ"å‚æ•°ç›¸ç­‰ä¹ˆ"

"ç›¸ç­‰ä¸ºtrue"å½“ç„¶"ä¸èƒ½åˆ·æ–°false",em~ å®ƒä¿©æ˜¯ç›¸åçš„ã€‚

### useMemo
é¿å…é‡å¤è®¡ç®—ï¼Œç±»ä¼¼è®¡ç®—å±æ€§
```js
useMemo(()=>{return "è®¡ç®—çš„å€¼"},[ä¾èµ–çš„å€¼])
```

*æ³¨æ„é—­åŒ…é™·é˜±ï¼Œé€»è¾‘ä¸­ç”¨åˆ°ä»€ä¹ˆï¼Œæœ€åå°±ä¾èµ–ä»€ä¹ˆ*
### useCallback
é¦–å…ˆå‡½æ•°æ˜¯å¼•ç”¨ç±»å‹ï¼Œæœ¬è´¨ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå‡½æ•°ç»„ä»¶å†…éƒ¨ä¼šåˆ›å»ºä¸€äº›å‡½æ•°æ¥ç»„ç»‡ä¸šåŠ¡ï¼Œå¹¶ä¸”è¿˜ä¼šä½œä¸ºå‚æ•°ä¼ å…¥å­èŠ‚ç‚¹ã€‚

é‚£ä¹ˆæ¯æ¬¡å‡½æ•°åˆ·æ–°ï¼Œå³ä½¿å‡½æ•°æœ¬èº«æ²¡æœ‰å˜åŒ–ï¼Œä¹Ÿä¼šé‡æ–°åˆ›å»ºæ–°çš„å‡½æ•°å¯¹è±¡ï¼Œæœ‰å¯èƒ½ä¼šå¼•èµ·ä¸å¿…è¦çš„åˆ·æ–°ï¼Œé¢‘ç¹åˆ›å»ºä¹Ÿä¼šæµªè´¹æ€§èƒ½ã€‚

æ‰€ç”¨ä½¿ç”¨`useCallback`è®°å½•ä¸€ä¸‹ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªé…ç½®ä¾èµ–ä»¥å“åº”æ›´æ–°çš„`useRef`
å†™æ³•å¦‚ä¸‹ï¼š

```js
useCallback(() => {}, [ä¾èµ–çš„å€¼]);
```

*æ³¨æ„é—­åŒ…é™·é˜±ï¼Œé€»è¾‘ä¸­ç”¨åˆ°ä»€ä¹ˆï¼Œæœ€åå°±ä¾èµ–ä»€ä¹ˆ*

# æ€»ç»“
é‚£ä¹ˆæˆ‘ä»¬æ¢³ç†ä¸€ä¸‹æ€è·¯ï¼Œæˆ‘ä»¬ä»`hooks`åŠ©åŠ›å‡½æ•°ç»„ä»¶èŠèµ·ï¼Œå¯¹hooksèƒ½å¤Ÿå»¶ç»­çš„é­”æ³•è€Œæ„Ÿåˆ°ç€è¿·ï¼Œè¿›è€Œæ¢ç´¢å†…éƒ¨çš„è¿è¡ŒåŸç†ï¼Œäº†è§£åˆ°äº†å»¶ç»­çš„å¥¥ç§˜å°½åœ¨`fiber`ä¹‹ä¸­ï¼Œæœ€åå†è¯´äº†è¯´ä½¿ç”¨`hooks`å¼€å‘çš„çš„äºŒä¸‰äº‹ï¼Œè¯•ç€å»ºç«‹ä»åŸç†åˆ°ä½¿ç”¨çš„ä¸€æ¡ç»†ç»†çš„é€šè·¯ï¼Œç›®çš„å°±æ˜¯å…ˆè°ƒé€šï¼Œè¿™æ ·ä¹‹åå­¦ä¹ å’Œè¡¥å……æ›´æœ‰ä¸»è§ï¼Œæ­£æ‰€è°“å…ˆè¿·åå¾—ä¸»ã€‚

# é¢˜å¤–è¯
æ¯å½“æˆ‘ç€è¿·Hooksçš„ç²¾å¦™ï¼Œå»æŸ¥é˜…ç›¸å…³èµ„æ–™çš„æ—¶å€™ï¼Œèµ·åˆçœŸçš„çœ‹çš„ä¸€å¤´é›¾æ°´ï¼Œå¹¶æ²¡ç¬¬ä¸€æ—¶é—´è§‰å¾—æ–‡ç« æœ‰å¤šå¥½ï¼Œéšç€æˆ‘åå¤çš„é˜…è¯»å¹¶åŠ¨æ‰‹è°ƒè¯•Reactæºç å»å°è¯ä¸€äº›ç–‘æƒ‘ï¼Œç»ˆäºå¦‚æˆ‘ä¸€èˆ¬æ™®é€šçš„coderä¹Ÿèƒ½å‹‰å¼ºæ„Ÿå—åˆ°æ–‡ç« çš„åŠŸåŠ›ï¼Œä½†è¿™å¼•å‘äº†æˆ‘çš„ä¸€ä¸ªæ€è€ƒï¼Œæ˜¯ä¸æ˜¯æ–‡ç« å‘åŠ›å¤ªæ·±ï¼Œå°±ç®—åŠ›é‡å†å¼ºï¼Œæ‰“ä¸åˆ°è¯»è€…ä¹Ÿæ˜¯å¼±ï¼Œå½“å¥½ä¸å¤§å®¶è¶Šæ¥è¶Šè¿œï¼Œæ¸æ¸åœ°æ²¡æœ‰äº†æ¬£èµï¼Œé‚£ä¹ˆä¹Ÿå°±æ²¡æœ‰äº†å¥½ï¼Œä¸­åº¸çš„æˆ‘å¸Œæœ›èƒ½å¤Ÿç²˜åˆä½äºŒè€…ï¼Œæ‰¾ä¸€ä¸ªåˆé€‚ä½ç½®å‘å‡ºæˆ‘çš„åŠ›ï¼Œå¦‚æœè¿™ä¸ªåŠ›èƒ½æ‰“åˆ°å°½å¯èƒ½å¤šçš„çš„äººï¼Œé‚£ä¹ˆå†å¼±çš„åŠ›ä¹Ÿæ˜¯å¼ºï¼Œè¿™æ ·å°±æœ‰å¯èƒ½å¸®åŠ©æ›´å¤šçš„äººå»æ¬£èµçœŸæ­£å¥½çš„æ–‡ç« ï¼Œå¤§å®¶éƒ½æƒ³å½“â€œç‰â€ï¼Œé‚£ä¹ˆæˆ‘å°±å»å½“ä¸ªâ€œç –å¤´â€å§ã€‚
