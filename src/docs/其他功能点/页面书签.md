# é¡µé¢ä¹¦ç­¾

ç®€å•è®²å°±æ˜¯ä½ ä»å½“å‰é¡µé¢è¿›è¡Œæ»šåŠ¨æµè§ˆï¼Œå½“â€œå‡ºå»ä¸€è¶Ÿâ€å†å›æ¥çš„æ—¶å€™ï¼Œè¦å¤åŸè¿™ä¸ªæ»šåŠ¨ä½ç½®ï¼Œå°±å¥½åƒä¸€æœ¬ä¹¦çš„ä¹¦ç­¾ä¸€æ ·ã€‚

# é‚£ä¹ˆå°±æè¿°ä¸‹å¯¹é¡µé¢ä¹¦ç­¾çš„æœŸæœ›å§

1. **å½“æˆ‘è·³è½¬å…¶ä»–é¡µé¢çš„æ—¶å€™ï¼Œå›æ¥è¦å¤åŸã€‚**
2. **å¤åŸä¸èƒ½ç›´æ¥å°±å®šä½å¤ªçªå…€ï¼Œåº”è¯¥æ˜¯åŠ¨ç”»ã€‚**

---

# é‚£ä¹ˆå¼€å§‹ç€æ‰‹å»å®ç°æœŸæœ›

## å¦‚ä½•å®ç° â€œ**å½“æˆ‘è·³è½¬å…¶ä»–é¡µé¢çš„æ—¶å€™ï¼Œå›æ¥è¦å¤åŸã€‚**â€

### é¡ºæ¨ä¸€ä¸‹æ€è·¯ï¼š

1. â€œå¤åŸâ€æ˜¯éœ€è¦ä¾é â€œæ•°æ®â€çš„ã€‚
2. "æ•°æ®"æ˜¯éœ€è¦åœ¨é¡µé¢ä¹‹é—´è·³è½¬ä¾ç„¶å¯ä»¥â€œä¿å­˜â€çš„
3. â€œä¿å­˜â€æ˜¯éœ€è¦è„±ç¦»é¡µé¢ä¹‹å¤–ä¸å—å…¶â€œæ§åˆ¶â€çš„
4. â€œæ§åˆ¶â€æ˜¯éœ€è¦è°æ¥åšå‘¢ğŸ¤”ï¼Ÿï¼Ÿï¼Ÿ

ç®€å•å•Šï¼Œé‚£æ˜æ˜¾å°±äº¤ç»™æ•°æ®ä»“åº“è¢«ğŸ˜„ã€‚

## å¦‚ä½•å®ç° â€œ**å¤åŸä¸èƒ½ç›´æ¥å°±å®šä½å¤ªçªå…€ï¼Œåº”è¯¥æ˜¯åŠ¨ç”»ã€‚**â€

### å†é¡ºæ¨ä¸€ä¸‹ï¼š

1. â€œåŠ¨ç”»â€æ˜¯éœ€è¦â€œç»†è…»â€çš„ã€‚
2. "ç»†è…»"æ˜¯éœ€è¦â€œè¿è´¯â€çš„ã€‚
3. â€œè¿è´¯â€æ˜¯éœ€è¦å¯¹æ­¤æ‰§è¡Œâ€œé€’å½’â€çš„ã€‚
4. â€œé€’å½’â€æ˜¯éœ€è¦è°æ¥åšå‘¢ğŸ¤”ï¼Ÿï¼Ÿï¼Ÿ


ç»è¿‡æ¢ç´¢ï¼ŒBomå¯¹è±¡çš„[requestAnimationFrame](https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame)å°±å¾ˆåˆé€‚ã€‚

**requestAnimationFrame å®˜æ–¹ä»‹ç»ï¼š**

> å‘Šè¯‰æµè§ˆå™¨â€”â€”ä½ å¸Œæœ›æ‰§è¡Œä¸€ä¸ªåŠ¨ç”»ï¼Œå¹¶ä¸”è¦æ±‚æµè§ˆå™¨åœ¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨æŒ‡å®šçš„å›è°ƒå‡½æ•°æ›´æ–°åŠ¨ç”»ã€‚è¯¥æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œè¯¥å›è°ƒå‡½æ•°ä¼šåœ¨æµè§ˆå™¨ä¸‹ä¸€æ¬¡é‡ç»˜ä¹‹å‰æ‰§è¡Œ

ç”»é¢ä¸€ç§’60fpsï¼Œé‚£ä¹ˆå›è°ƒå‡½æ•°æ‰§è¡Œæ¬¡æ•°é€šå¸¸æ˜¯æ¯ç§’60æ¬¡ï¼ˆé™¤äº†å¡æ‰å¸§äº†ï¼‰é‚£å°±è¶³å¤Ÿâ€œè¿è´¯â€äº†ï¼Œæ²¡æ¬¡åšä¸€ç‚¹æ”¹å˜ï¼Œè¿ç»­åšå°±èƒ½åšåˆ°â€œç»†è…»â€äº†ï¼ˆè¿™å°±è·Ÿæ¸¸æˆå¼€å‘æ²¡å•¥åŒºåˆ«äº†ï¼‰ã€‚

è¿™é‡Œå¿…é¡»è¦å¼ºè°ƒä¸€ä¸‹ï¼ŒæŸ¥é˜…äº†å‡ ç¯‡æ–‡ç« ï¼Œæœ‰ä¸å°‘éƒ½è¯´é”™äº†ä¸€ä¸ªç‚¹ï¼ˆæˆ‘è§‰å¾—çš„ï¼‰

æ¯”å¦‚è¿™å¥ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/311b40fddcf04e61a3493e57b1d14251~tplv-k3u1fbpfcp-zoom-1.image)

ä½ è¿™ä¹ˆè¯´å°±å¥½åƒè·Ÿ`setinterval`ä¼¼çš„äº†ï¼Œæˆ‘è§‰å¾—ä¸å¯¹ï¼Œé€»è¾‘çŸ›ç›¾äº†ã€‚

**æˆ‘çš„ç†è§£**ï¼šé¡µé¢ä¸€ç§’60fpsï¼Œé‚£ä¹ˆä½ æ‰§è¡Œäº†`requestAnimationFrame`,é‚£ä¹ˆåªæ˜¯åœ¨**ä¸‹ä¸€æ¬¡**å±å¹•ç»˜åˆ¶çš„æ—¶å€™**æ‰§è¡Œä¸€æ¬¡**ï¼Œé‚£ä¹ˆæ€ä¹ˆè¿è´¯çš„å‘¢ï¼Œé‚£æ˜¯é€šè¿‡**é€’å½’æ‰§è¡Œ**è¿™ä¸ªå‡½æ•°å®ç°çš„ï¼Œä»£ç å°±æ˜¯è¿™ä¹ˆè¯´çš„ã€‚ä¸ä¼šéª—äººçš„ã€‚

**ä¸Šä»£ç ï¼š**

```js
export function sineaseOut(t, b, c, d) {
    return c * ((t = t / d - 1) * t * t + 1) + b
}
export function scrollToView(scroller, value) {
    if (!scroller) {
        return
    }

    const scroll = value
    const scrollStart = 0
    let start = null
    const step = (timestamp) => {
        if (!start) {
            start = timestamp
        }
        let stepScroll = sineaseOut(timestamp - start, 0, scroll, 500)
        let total = scroller.scrollTop = scrollStart + stepScroll
        if (total < scrollStart + scroll) {
            requestAnimationFrame(step)
        }
    }
    requestAnimationFrame(step)
}
```

## é‚£ä¹ˆåšä¸ªå°ç»“

* çŠ¶æ€æ•°æ®äº¤ç”±æ•°æ®ç®¡ç†å™¨`Mobx`æ¥è´Ÿè´£ï¼Œ`mobx`æ´¾`global`ä»“åº“æ¥åšã€‚

* åŠ¨ç”»çš„ç»†è…»å°±é€šè¿‡ä¸€ç§’60æ¬¡çš„ç»˜åˆ¶è¿›è¡Œé€’å½’è°ƒç”¨`requestAnimationFrame`æ¥å®ç°ã€‚

---

# é“ç†éƒ½æ‡‚ï¼Œé‚£ä¹ˆç„¶åå‘¢ï¼Ÿ

å“å‘€ï¼Œç¡®å®å•Šã€‚ã€‚ã€‚è™½ç„¶ä¸¤ä¸ªéƒ½æœ‰åŠæ³•è§£å†³äº†ï¼Œä½†è¿˜æœ‰æœ€æœ€å…³é”®çš„é—®é¢˜ï¼Œâ€œ**ç”¨æ­¦ä¹‹åœ°**â€åœ¨å“ªå•Šï¼Ÿï¼Ÿï¼Ÿ

## â€œç”¨æ­¦ä¹‹åœ°â€å¯æ˜¯å¾ˆçœ‹â€œé£æ°´â€çš„å“¦

ä½ç½®è¦æ˜¯æ²¡é€‰å¥½ï¼Œé‚£ç®€ç›´è®©ä½ çš„ä»£ç ä¸­å¤„å¤„å……æ»¡äº†**åšä½œ**ï¼Œå°±ä¸ºäº†çœ‹èµ·æ¥èˆ’æœé‚£ä¹ˆä¸€ç‚¹ï¼Œé‚£å°±è·Ÿâ€œ**æ‰“è‚¿è„¸å……èƒ–å­**â€å·®ä¸å¤šäº†ã€‚

## æœ€å±é™©çš„é™·é˜±å¾€å¾€å¾ˆæ¸©æŸ”

é¦–å…ˆä»éœ€æ±‚ä¸Šæ¥çœ‹ï¼Œå¾ˆå®¹æ˜“å°±è”æƒ³åˆ°ç»„ä»¶çš„å¸è½½å’ŒæŒ‚è½½ï¼Œå› ä¸ºçœŸçš„å¾ˆåŒ¹é…ï¼Œè¿™å°±æ˜¯**æœ€å¤§çš„è¯±æƒ‘**ï¼Œå› ä¸ºå®ƒèƒ½å®ç°ï¼Œä½†è¿™ç»ä¸æ˜¯å¥½çš„åŠæ³•ï¼Œè‡³å°‘ä¸æ˜¯æœ€å¥½çš„ï¼Œå› ä¸ºä½ å¦‚æœçœŸè¿™ä¹ˆåšäº†ï¼Œé‚£æ‰€æœ‰çš„é¡µé¢ç»„ä»¶éƒ½è¦å»å†™è¿™ä¸ªé‡å¤çš„é€»è¾‘ï¼Œé‚£å¤ªçƒ¦äº†ï¼Œå¦‚æœæ˜¯ç»™ä¸€ä¸ªå·²ç»å†™å¥½äº†å¾ˆå¤šé¡µé¢çš„é¡¹ç›®åŠ ï¼Œä½ ä¼šå´©æºƒçš„ï¼Œè¿™**ä¸èƒ½æ¥å—**ã€‚

## è¦æŠ“ä½ä¹Œäº‘èƒŒåçš„å¹¸ç¦çº¿

å½“æˆ‘æƒ³æ¥æƒ³å»ï¼Œå‡ ç»æ³¢æŠ˜ï¼Œå·®ç‚¹â€œçœŸé¦™â€çš„æ—¶å€™ï¼Œç»ˆäºè®©æˆ‘æƒ³åˆ°äº†ä¸€ä¸ªæä½³çš„ä½ç½®ï¼Œé‚£å°±æ˜¯ã€‚

`history.listen`

é‚£æ—¶é‚£åˆ»ï¼Œæˆ‘è‡ªä¿¡åœ°å˜´è§’å¾®å¾®ä¸Šæ‰¬ï¼Œç¨³äº†ğŸ˜„ã€‚

ç›´æ¥ä¸Šä»£ç ï¼Œæˆ‘ç›¸ä¿¡bæ•°è‡ªåœ¨å¤§å®¶å¿ƒä¸­ï¼Œæ— éœ€å¤šè¨€äº†ã€‚

```js
    let history = useHistory();
    let location = useLocation();
    const {
        global: { current, scrollData, changeParams },
    } = store;
    useEffect(() => {
        const { pathname, search } = location;
        changeParams({
            current: decodeURIComponent(pathname + search)
        })
        if (!history._listenCount) {
            history._listenCount++;
            history.listen((locationState, type) => {
                const {
                    global: { current, scrollData, changeParams },
                } = store;
                let node = document.getElementsByClassName('ant-layout-content')[0]
                if (!node) {
                    return
                }
                // node.scrollTop = 0;
                //æœ€æ–°é¡µé¢çš„Keyï¼Œå­˜ä¸Šå°±è¡Œ
                let newkey = decodeURIComponent(locationState.pathname + locationState.search);
                /* æ‰¾ä¸€ä¸‹çœ‹çœ‹æœ‰æ²¡æœ‰è®°å½•å€¼ */
                let recordValue = scrollData[newkey]
                if (typeof recordValue === 'number') {
                    scrollToView(node, recordValue)
                }
                // å–å€¼ï¼ˆè¿‡å»çš„ï¼‰å­˜ä¸€ä¸‹ï¼Œold
                let oldKey = current;
                let scrollDataTemp = { ...toJS(scrollData), [oldKey]: node.scrollTop }
                if (type === "POP") {
                    //POP æƒ…å†µä¸‹node.scrollTopå·²ç»è¢«è®¾ç½®æˆ0äº†
                    changeParams({
                        current: newkey,
                    })
                } else {
                    changeParams({
                        current: newkey,
                        scrollData: scrollDataTemp
                    })
                }
            })
        }
    }, [])
```


ä»£ç å¾ˆæ¸…æ™°ï¼Œå°±æ˜¯é¡µé¢èµ°äº†ï¼Œè®°å½•ä¸€ä¸‹ï¼Œé¡µé¢å›æ¥ï¼Œæ¢å¤ä¸€ä¸‹ï¼Œè§£å†³çš„å°±æ˜¯è¿™ä¹ˆç®€å•è‡ªç„¶ã€‚

---

# çœ‹ä¸‹æ•ˆæœ
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/15424039c47f40c392691e919ae7fdc7~tplv-k3u1fbpfcp-zoom-1.image)

---

# ç»“è¯­

é€šè¿‡æ¢ç´¢**é¡µé¢ä¹¦ç­¾**åŠŸèƒ½çš„å®ç°æ–¹å¼ï¼Œèƒ½å¤Ÿæ›´å¥½çš„ä½“ä¼šä¸€ä¸ªé“ç†ï¼Œå®ç°çš„æ–¹å¼ä¸æ­¢ä¸€ç§ï¼Œæ¸…æ¥šè‡ªå·±æƒ³è¦ä»€ä¹ˆï¼Œä½ ä¹Ÿå°±çŸ¥é“è‡ªå·±è¯¥åšæŒä»€ä¹ˆï¼Œè¯¥æ€ä¹ˆåšï¼Œä¹Ÿå°±æ›´æœ‰å¯èƒ½æŠ“ä½ä¹Œäº‘èƒŒåçš„å¹¸ç¦çº¿ã€‚

[é›†æˆäº†è¯¥åŠŸèƒ½çš„ğŸŒ°](https://github.com/moderateReact/moderate-react-template)

